<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>終極登入診斷</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            min-height: 100vh;
            padding: 10px;
        }
        .container {
            max-width: 500px;
            margin: 0 auto;
            background: rgba(255,255,255,0.1);
            padding: 20px;
            border-radius: 15px;
            backdrop-filter: blur(10px);
        }
        h1 { text-align: center; margin-bottom: 20px; font-size: 20px; }
        .section {
            background: rgba(255,255,255,0.1);
            padding: 15px;
            margin: 15px 0;
            border-radius: 10px;
        }
        .section h3 {
            margin-bottom: 10px;
            color: #ffd700;
            font-size: 16px;
        }
        button {
            width: 100%;
            padding: 12px;
            margin: 8px 0;
            border: none;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            background: white;
            color: #333;
            transition: all 0.2s;
        }
        button:hover { transform: translateY(-1px); }
        button:disabled { opacity: 0.5; cursor: not-allowed; }
        .log {
            background: rgba(0,0,0,0.3);
            padding: 10px;
            margin: 10px 0;
            border-radius: 5px;
            font-family: monospace;
            font-size: 11px;
            max-height: 150px;
            overflow-y: auto;
            white-space: pre-wrap;
        }
        .status {
            padding: 8px;
            margin: 8px 0;
            border-radius: 5px;
            font-weight: bold;
        }
        .success { background: rgba(76,175,80,0.8); }
        .error { background: rgba(244,67,54,0.8); }
        .info { background: rgba(33,150,243,0.8); }
        .warning { background: rgba(255,152,0,0.8); }
        .small { font-size: 11px; opacity: 0.8; }
    </style>
</head>
<body>
    <div class="container">
        <h1>🔍 終極登入診斷工具</h1>
        
        <div class="section">
            <h3>📱 設備資訊</h3>
            <div id="deviceInfo" class="small">檢測中...</div>
        </div>
        
        <div class="section">
            <h3>🔥 Firebase 狀態</h3>
            <button onclick="checkFirebaseStatus()">檢查 Firebase 配置</button>
            <div id="firebaseStatus"></div>
        </div>
        
        <div class="section">
            <h3>🚀 登入測試</h3>
            <button onclick="testPopupLogin()">測試彈出視窗登入</button>
            <button onclick="testRedirectLogin()">測試重定向登入</button>
            <button onclick="testDirectRedirect()">直接重定向 (不檢查)</button>
            <button onclick="openGoogleDirectly()">直接開啟 Google OAuth</button>
        </div>
        
        <div class="section">
            <h3>🔍 診斷檢查</h3>
            <button onclick="checkCurrentAuth()">檢查當前認證狀態</button>
            <button onclick="checkRedirectResult()">檢查重定向結果</button>
            <button onclick="clearAllData()">清除所有資料</button>
        </div>
        
        <div id="status"></div>
        <div class="log" id="log"></div>
    </div>

    <script type="module">
        // Firebase 配置 - 使用與主應用程式相同的配置
        const firebaseConfig = {
            apiKey: "AIzaSyB1DXR1TC11ZDhIXAeyWyn0gXnxaYW6Cjs",
            authDomain: "my-wallet-app-815ce.firebaseapp.com",
            projectId: "my-wallet-app-815ce",
            storageBucket: "my-wallet-app-815ce.firebasestorage.app",
            messagingSenderId: "656225813708",
            appId: "1:656225813708:web:2acd800eedd53408b4ae69",
            measurementId: "G-Z9MECGE7T0"
        };

        let app, auth;
        let authModule;

        // 日誌和狀態函數
        function log(message) {
            const logDiv = document.getElementById('log');
            const timestamp = new Date().toLocaleTimeString();
            logDiv.textContent += `[${timestamp}] ${message}\n`;
            logDiv.scrollTop = logDiv.scrollHeight;
            console.log(message);
        }

        function showStatus(message, type = 'info') {
            const statusDiv = document.getElementById('status');
            statusDiv.innerHTML = `<div class="status ${type}">${message}</div>`;
        }

        // 設備檢測
        function detectDevice() {
            const ua = navigator.userAgent;
            const info = {
                isMobile: /Android|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(ua),
                isIOS: /iPad|iPhone|iPod/.test(ua),
                isAndroid: /Android/i.test(ua),
                isSafari: /Safari/.test(ua) && !/Chrome/.test(ua),
                isChrome: /Chrome/.test(ua),
                isFirefox: /Firefox/.test(ua),
                isStandalone: window.matchMedia('(display-mode: standalone)').matches || window.navigator.standalone,
                supportsPWA: 'serviceWorker' in navigator,
                cookiesEnabled: navigator.cookieEnabled,
                localStorageAvailable: (() => {
                    try { return 'localStorage' in window && window.localStorage !== null; }
                    catch(e) { return false; }
                })(),
                sessionStorageAvailable: (() => {
                    try { return 'sessionStorage' in window && window.sessionStorage !== null; }
                    catch(e) { return false; }
                })(),
                thirdPartyCookies: 'unknown'
            };

            // 檢查第三方 Cookie
            try {
                document.cookie = "test=1; SameSite=None; Secure";
                info.thirdPartyCookies = document.cookie.includes("test=1") ? 'enabled' : 'blocked';
                document.cookie = "test=; expires=Thu, 01 Jan 1970 00:00:00 GMT; SameSite=None; Secure";
            } catch (e) {
                info.thirdPartyCookies = 'error';
            }

            const deviceDiv = document.getElementById('deviceInfo');
            deviceDiv.innerHTML = `
                📱 手機: ${info.isMobile ? '是' : '否'} | 
                🍎 iOS: ${info.isIOS ? '是' : '否'} | 
                🤖 Android: ${info.isAndroid ? '是' : '否'}<br>
                🌐 Safari: ${info.isSafari ? '是' : '否'} | 
                💻 Chrome: ${info.isChrome ? '是' : '否'} | 
                🦊 Firefox: ${info.isFirefox ? '是' : '否'}<br>
                🚀 PWA模式: ${info.isStandalone ? '是' : '否'} | 
                🔧 ServiceWorker: ${info.supportsPWA ? '支援' : '不支援'}<br>
                🍪 Cookies: ${info.cookiesEnabled ? '啟用' : '停用'} | 
                🍪 第三方Cookie: ${info.thirdPartyCookies}<br>
                💾 LocalStorage: ${info.localStorageAvailable ? '可用' : '不可用'} | 
                💾 SessionStorage: ${info.sessionStorageAvailable ? '可用' : '不可用'}
            `;

            log(`設備檢測完成: ${JSON.stringify(info, null, 2)}`);
            return info;
        }

        // 初始化 Firebase
        async function initFirebase() {
            try {
                log('=== 初始化 Firebase ===');
                
                const { initializeApp } = await import('https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js');
                const { getAuth, onAuthStateChanged } = await import('https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js');
                
                app = initializeApp(firebaseConfig);
                auth = getAuth(app);
                
                authModule = await import('https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js');
                
                // 設定認證監聽器
                onAuthStateChanged(auth, (user) => {
                    if (user) {
                        log(`✅ 認證狀態: 已登入 - ${user.email}`);
                        showStatus(`已登入: ${user.displayName || user.email}`, 'success');
                    } else {
                        log('❌ 認證狀態: 未登入');
                        showStatus('未登入', 'info');
                    }
                });

                log('✅ Firebase 初始化成功');
                return true;
            } catch (error) {
                log(`❌ Firebase 初始化失敗: ${error.message}`);
                showStatus(`Firebase 初始化失敗: ${error.message}`, 'error');
                return false;
            }
        }

        // 檢查 Firebase 狀態
        window.checkFirebaseStatus = async function() {
            try {
                log('=== 檢查 Firebase 配置 ===');
                
                // 檢查配置
                log(`API Key: ${firebaseConfig.apiKey ? '✅ 已設定' : '❌ 未設定'}`);
                log(`Auth Domain: ${firebaseConfig.authDomain}`);
                log(`Project ID: ${firebaseConfig.projectId}`);
                
                // 檢查網路連線
                const response = await fetch(`https://${firebaseConfig.authDomain}`);
                log(`Firebase 連線: ${response.ok ? '✅ 正常' : '❌ 失敗'}`);
                
                // 檢查 Auth 服務
                if (auth) {
                    log('✅ Firebase Auth 已初始化');
                    log(`當前用戶: ${auth.currentUser ? auth.currentUser.email : '無'}`);
                } else {
                    log('❌ Firebase Auth 未初始化');
                }
                
                showStatus('Firebase 狀態檢查完成', 'success');
                
            } catch (error) {
                log(`❌ Firebase 狀態檢查失敗: ${error.message}`);
                showStatus(`檢查失敗: ${error.message}`, 'error');
            }
        };

        // 測試彈出視窗登入
        window.testPopupLogin = async function() {
            try {
                log('=== 測試彈出視窗登入 ===');
                
                if (!authModule) throw new Error('Auth 模組未載入');
                
                const { GoogleAuthProvider, signInWithPopup } = authModule;
                const provider = new GoogleAuthProvider();
                provider.addScope('email');
                provider.addScope('profile');
                
                log('發送彈出視窗登入請求...');
                showStatus('正在開啟登入視窗...', 'info');
                
                const result = await signInWithPopup(auth, provider);
                
                if (result && result.user) {
                    log(`✅ 彈出視窗登入成功: ${result.user.email}`);
                    showStatus(`登入成功: ${result.user.email}`, 'success');
                } else {
                    log('❌ 彈出視窗登入失敗: 沒有結果');
                    showStatus('登入失敗: 沒有結果', 'error');
                }
                
            } catch (error) {
                log(`❌ 彈出視窗登入失敗: ${error.code} - ${error.message}`);
                showStatus(`彈出視窗登入失敗: ${error.message}`, 'error');
            }
        };

        // 測試重定向登入
        window.testRedirectLogin = async function() {
            try {
                log('=== 測試重定向登入 ===');
                
                if (!authModule) throw new Error('Auth 模組未載入');
                
                const { GoogleAuthProvider, signInWithRedirect } = authModule;
                const provider = new GoogleAuthProvider();
                provider.addScope('email');
                provider.addScope('profile');
                provider.setCustomParameters({
                    'prompt': 'select_account'
                });
                
                log('發送重定向登入請求...');
                showStatus('正在重定向到 Google...', 'info');
                
                // 記錄嘗試
                sessionStorage.setItem('redirectLoginAttempt', Date.now().toString());
                localStorage.setItem('redirectLoginAttempt', Date.now().toString());
                
                await signInWithRedirect(auth, provider);
                log('✅ 重定向請求已發送 (頁面應該跳轉)');
                
            } catch (error) {
                log(`❌ 重定向登入失敗: ${error.code} - ${error.message}`);
                showStatus(`重定向登入失敗: ${error.message}`, 'error');
            }
        };

        // 直接重定向 (跳過檢查)
        window.testDirectRedirect = async function() {
            try {
                log('=== 直接重定向測試 ===');
                
                const clientId = '656225813708-具體的client_id.apps.googleusercontent.com';
                const redirectUri = encodeURIComponent(window.location.origin + '/accounting/ultimate-debug.html');
                const scope = encodeURIComponent('email profile');
                
                const googleOAuthUrl = `https://accounts.google.com/o/oauth2/v2/auth?` +
                    `client_id=${clientId}&` +
                    `redirect_uri=${redirectUri}&` +
                    `response_type=code&` +
                    `scope=${scope}&` +
                    `prompt=select_account`;
                
                log(`直接重定向 URL: ${googleOAuthUrl}`);
                showStatus('正在跳轉到 Google (直接方式)...', 'info');
                
                sessionStorage.setItem('directRedirectAttempt', Date.now().toString());
                
                window.location.href = googleOAuthUrl;
                
            } catch (error) {
                log(`❌ 直接重定向失敗: ${error.message}`);
                showStatus(`直接重定向失敗: ${error.message}`, 'error');
            }
        };

        // 直接開啟 Google OAuth
        window.openGoogleDirectly = function() {
            const googleOAuthBase = 'https://accounts.google.com/o/oauth2/v2/auth';
            const params = new URLSearchParams({
                client_id: '656225813708-你的完整client_id.apps.googleusercontent.com',
                redirect_uri: window.location.origin + window.location.pathname,
                response_type: 'code',
                scope: 'email profile',
                prompt: 'select_account'
            });
            
            const url = `${googleOAuthBase}?${params.toString()}`;
            log(`Google OAuth URL: ${url}`);
            
            // 在新視窗開啟看看是否有錯誤
            const popup = window.open(url, 'google_oauth', 'width=500,height=600');
            
            if (!popup) {
                log('❌ 無法開啟彈出視窗 - 可能被阻擋');
                showStatus('彈出視窗被阻擋', 'error');
            } else {
                log('✅ Google OAuth 視窗已開啟');
                showStatus('Google OAuth 視窗已開啟', 'info');
            }
        };

        // 檢查當前認證狀態
        window.checkCurrentAuth = function() {
            log('=== 檢查當前認證狀態 ===');
            
            if (auth && auth.currentUser) {
                const user = auth.currentUser;
                log(`✅ 當前用戶: ${user.email}`);
                log(`- 顯示名稱: ${user.displayName}`);
                log(`- UID: ${user.uid}`);
                log(`- 信箱驗證: ${user.emailVerified}`);
                showStatus(`已登入: ${user.email}`, 'success');
            } else {
                log('❌ 當前沒有用戶');
                showStatus('未登入', 'info');
            }
            
            // 檢查 session storage
            const sessionAttempt = sessionStorage.getItem('redirectLoginAttempt');
            const localAttempt = localStorage.getItem('redirectLoginAttempt');
            
            if (sessionAttempt) log(`Session 登入嘗試: ${new Date(parseInt(sessionAttempt))}`);
            if (localAttempt) log(`Local 登入嘗試: ${new Date(parseInt(localAttempt))}`);
        };

        // 檢查重定向結果
        window.checkRedirectResult = async function() {
            try {
                log('=== 檢查重定向結果 ===');
                
                if (!authModule) throw new Error('Auth 模組未載入');
                
                const { getRedirectResult } = authModule;
                
                log('呼叫 getRedirectResult...');
                const result = await getRedirectResult(auth);
                
                if (result && result.user) {
                    log(`✅ 發現重定向結果: ${result.user.email}`);
                    log(`- 顯示名稱: ${result.user.displayName}`);
                    log(`- UID: ${result.user.uid}`);
                    showStatus(`重定向登入成功: ${result.user.email}`, 'success');
                    
                    // 清除嘗試記錄
                    sessionStorage.removeItem('redirectLoginAttempt');
                    localStorage.removeItem('redirectLoginAttempt');
                    
                } else {
                    log('ℹ️ 沒有重定向結果');
                    showStatus('沒有重定向結果', 'warning');
                    
                    // 檢查是否有嘗試記錄但沒有結果
                    const sessionAttempt = sessionStorage.getItem('redirectLoginAttempt');
                    const localAttempt = localStorage.getItem('redirectLoginAttempt');
                    
                    if (sessionAttempt || localAttempt) {
                        log('⚠️ 有登入嘗試記錄但沒有重定向結果 - 可能登入失敗');
                        showStatus('登入可能失敗 - 有嘗試記錄但無結果', 'error');
                    }
                }
                
            } catch (error) {
                log(`❌ 檢查重定向結果失敗: ${error.code} - ${error.message}`);
                showStatus(`檢查失敗: ${error.message}`, 'error');
            }
        };

        // 清除所有資料
        window.clearAllData = async function() {
            try {
                log('=== 清除所有資料 ===');
                
                // 登出
                if (auth && auth.currentUser) {
                    const { signOut } = authModule;
                    await signOut(auth);
                    log('✅ 已登出');
                }
                
                // 清除儲存
                sessionStorage.clear();
                localStorage.clear();
                log('✅ 已清除所有儲存');
                
                // 清除 cookies
                document.cookie.split(";").forEach(function(c) { 
                    document.cookie = c.replace(/^ +/, "").replace(/=.*/, "=;expires=" + new Date().toUTCString() + ";path=/"); 
                });
                log('✅ 已清除 cookies');
                
                showStatus('所有資料已清除', 'success');
                
                // 重新載入頁面
                setTimeout(() => {
                    location.reload();
                }, 1500);
                
            } catch (error) {
                log(`❌ 清除資料失敗: ${error.message}`);
                showStatus(`清除失敗: ${error.message}`, 'error');
            }
        };

        // 頁面載入時執行
        window.addEventListener('load', async () => {
            log('=== 終極診斷工具啟動 ===');
            detectDevice();
            
            const success = await initFirebase();
            if (success) {
                // 自動檢查重定向結果
                setTimeout(() => {
                    checkRedirectResult();
                }, 1000);
            }
        });

    </script>
</body>
</html>

<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>çµ‚æ¥µç™»å…¥è¨ºæ–·</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            min-height: 100vh;
            padding: 10px;
        }
        .container {
            max-width: 500px;
            margin: 0 auto;
            background: rgba(255,255,255,0.1);
            padding: 20px;
            border-radius: 15px;
            backdrop-filter: blur(10px);
        }
        h1 { text-align: center; margin-bottom: 20px; font-size: 20px; }
        .section {
            background: rgba(255,255,255,0.1);
            padding: 15px;
            margin: 15px 0;
            border-radius: 10px;
        }
        .section h3 {
            margin-bottom: 10px;
            color: #ffd700;
            font-size: 16px;
        }
        button {
            width: 100%;
            padding: 12px;
            margin: 8px 0;
            border: none;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            background: white;
            color: #333;
            transition: all 0.2s;
        }
        button:hover { transform: translateY(-1px); }
        button:disabled { opacity: 0.5; cursor: not-allowed; }
        .log {
            background: rgba(0,0,0,0.3);
            padding: 10px;
            margin: 10px 0;
            border-radius: 5px;
            font-family: monospace;
            font-size: 11px;
            max-height: 150px;
            overflow-y: auto;
            white-space: pre-wrap;
        }
        .status {
            padding: 8px;
            margin: 8px 0;
            border-radius: 5px;
            font-weight: bold;
        }
        .success { background: rgba(76,175,80,0.8); }
        .error { background: rgba(244,67,54,0.8); }
        .info { background: rgba(33,150,243,0.8); }
        .warning { background: rgba(255,152,0,0.8); }
        .small { font-size: 11px; opacity: 0.8; }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ” çµ‚æ¥µç™»å…¥è¨ºæ–·å·¥å…·</h1>
        
        <div class="section">
            <h3>ğŸ“± è¨­å‚™è³‡è¨Š</h3>
            <div id="deviceInfo" class="small">æª¢æ¸¬ä¸­...</div>
        </div>
        
        <div class="section">
            <h3>ğŸ”¥ Firebase ç‹€æ…‹</h3>
            <button onclick="checkFirebaseStatus()">æª¢æŸ¥ Firebase é…ç½®</button>
            <div id="firebaseStatus"></div>
        </div>
        
        <div class="section">
            <h3>ğŸš€ ç™»å…¥æ¸¬è©¦</h3>
            <button onclick="testPopupLogin()">æ¸¬è©¦å½ˆå‡ºè¦–çª—ç™»å…¥</button>
            <button onclick="testRedirectLogin()">æ¸¬è©¦é‡å®šå‘ç™»å…¥</button>
            <button onclick="testDirectRedirect()">ç›´æ¥é‡å®šå‘ (ä¸æª¢æŸ¥)</button>
            <button onclick="openGoogleDirectly()">ç›´æ¥é–‹å•Ÿ Google OAuth</button>
        </div>
        
        <div class="section">
            <h3>ğŸ” è¨ºæ–·æª¢æŸ¥</h3>
            <button onclick="checkCurrentAuth()">æª¢æŸ¥ç•¶å‰èªè­‰ç‹€æ…‹</button>
            <button onclick="checkRedirectResult()">æª¢æŸ¥é‡å®šå‘çµæœ</button>
            <button onclick="clearAllData()">æ¸…é™¤æ‰€æœ‰è³‡æ–™</button>
        </div>
        
        <div id="status"></div>
        <div class="log" id="log"></div>
    </div>

    <script type="module">
        // Firebase é…ç½® - ä½¿ç”¨èˆ‡ä¸»æ‡‰ç”¨ç¨‹å¼ç›¸åŒçš„é…ç½®
        const firebaseConfig = {
            apiKey: "AIzaSyB1DXR1TC11ZDhIXAeyWyn0gXnxaYW6Cjs",
            authDomain: "my-wallet-app-815ce.firebaseapp.com",
            projectId: "my-wallet-app-815ce",
            storageBucket: "my-wallet-app-815ce.firebasestorage.app",
            messagingSenderId: "656225813708",
            appId: "1:656225813708:web:2acd800eedd53408b4ae69",
            measurementId: "G-Z9MECGE7T0"
        };

        let app, auth;
        let authModule;

        // æ—¥èªŒå’Œç‹€æ…‹å‡½æ•¸
        function log(message) {
            const logDiv = document.getElementById('log');
            const timestamp = new Date().toLocaleTimeString();
            logDiv.textContent += `[${timestamp}] ${message}\n`;
            logDiv.scrollTop = logDiv.scrollHeight;
            console.log(message);
        }

        function showStatus(message, type = 'info') {
            const statusDiv = document.getElementById('status');
            statusDiv.innerHTML = `<div class="status ${type}">${message}</div>`;
        }

        // è¨­å‚™æª¢æ¸¬
        function detectDevice() {
            const ua = navigator.userAgent;
            const info = {
                isMobile: /Android|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(ua),
                isIOS: /iPad|iPhone|iPod/.test(ua),
                isAndroid: /Android/i.test(ua),
                isSafari: /Safari/.test(ua) && !/Chrome/.test(ua),
                isChrome: /Chrome/.test(ua),
                isFirefox: /Firefox/.test(ua),
                isStandalone: window.matchMedia('(display-mode: standalone)').matches || window.navigator.standalone,
                supportsPWA: 'serviceWorker' in navigator,
                cookiesEnabled: navigator.cookieEnabled,
                localStorageAvailable: (() => {
                    try { return 'localStorage' in window && window.localStorage !== null; }
                    catch(e) { return false; }
                })(),
                sessionStorageAvailable: (() => {
                    try { return 'sessionStorage' in window && window.sessionStorage !== null; }
                    catch(e) { return false; }
                })(),
                thirdPartyCookies: 'unknown'
            };

            // æª¢æŸ¥ç¬¬ä¸‰æ–¹ Cookie
            try {
                document.cookie = "test=1; SameSite=None; Secure";
                info.thirdPartyCookies = document.cookie.includes("test=1") ? 'enabled' : 'blocked';
                document.cookie = "test=; expires=Thu, 01 Jan 1970 00:00:00 GMT; SameSite=None; Secure";
            } catch (e) {
                info.thirdPartyCookies = 'error';
            }

            const deviceDiv = document.getElementById('deviceInfo');
            deviceDiv.innerHTML = `
                ğŸ“± æ‰‹æ©Ÿ: ${info.isMobile ? 'æ˜¯' : 'å¦'} | 
                ğŸ iOS: ${info.isIOS ? 'æ˜¯' : 'å¦'} | 
                ğŸ¤– Android: ${info.isAndroid ? 'æ˜¯' : 'å¦'}<br>
                ğŸŒ Safari: ${info.isSafari ? 'æ˜¯' : 'å¦'} | 
                ğŸ’» Chrome: ${info.isChrome ? 'æ˜¯' : 'å¦'} | 
                ğŸ¦Š Firefox: ${info.isFirefox ? 'æ˜¯' : 'å¦'}<br>
                ğŸš€ PWAæ¨¡å¼: ${info.isStandalone ? 'æ˜¯' : 'å¦'} | 
                ğŸ”§ ServiceWorker: ${info.supportsPWA ? 'æ”¯æ´' : 'ä¸æ”¯æ´'}<br>
                ğŸª Cookies: ${info.cookiesEnabled ? 'å•Ÿç”¨' : 'åœç”¨'} | 
                ğŸª ç¬¬ä¸‰æ–¹Cookie: ${info.thirdPartyCookies}<br>
                ğŸ’¾ LocalStorage: ${info.localStorageAvailable ? 'å¯ç”¨' : 'ä¸å¯ç”¨'} | 
                ğŸ’¾ SessionStorage: ${info.sessionStorageAvailable ? 'å¯ç”¨' : 'ä¸å¯ç”¨'}
            `;

            log(`è¨­å‚™æª¢æ¸¬å®Œæˆ: ${JSON.stringify(info, null, 2)}`);
            return info;
        }

        // åˆå§‹åŒ– Firebase
        async function initFirebase() {
            try {
                log('=== åˆå§‹åŒ– Firebase ===');
                
                const { initializeApp } = await import('https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js');
                const { getAuth, onAuthStateChanged } = await import('https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js');
                
                app = initializeApp(firebaseConfig);
                auth = getAuth(app);
                
                authModule = await import('https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js');
                
                // è¨­å®šèªè­‰ç›£è½å™¨
                onAuthStateChanged(auth, (user) => {
                    if (user) {
                        log(`âœ… èªè­‰ç‹€æ…‹: å·²ç™»å…¥ - ${user.email}`);
                        showStatus(`å·²ç™»å…¥: ${user.displayName || user.email}`, 'success');
                    } else {
                        log('âŒ èªè­‰ç‹€æ…‹: æœªç™»å…¥');
                        showStatus('æœªç™»å…¥', 'info');
                    }
                });

                log('âœ… Firebase åˆå§‹åŒ–æˆåŠŸ');
                return true;
            } catch (error) {
                log(`âŒ Firebase åˆå§‹åŒ–å¤±æ•—: ${error.message}`);
                showStatus(`Firebase åˆå§‹åŒ–å¤±æ•—: ${error.message}`, 'error');
                return false;
            }
        }

        // æª¢æŸ¥ Firebase ç‹€æ…‹
        window.checkFirebaseStatus = async function() {
            try {
                log('=== æª¢æŸ¥ Firebase é…ç½® ===');
                
                // æª¢æŸ¥é…ç½®
                log(`API Key: ${firebaseConfig.apiKey ? 'âœ… å·²è¨­å®š' : 'âŒ æœªè¨­å®š'}`);
                log(`Auth Domain: ${firebaseConfig.authDomain}`);
                log(`Project ID: ${firebaseConfig.projectId}`);
                
                // æª¢æŸ¥ç¶²è·¯é€£ç·š
                const response = await fetch(`https://${firebaseConfig.authDomain}`);
                log(`Firebase é€£ç·š: ${response.ok ? 'âœ… æ­£å¸¸' : 'âŒ å¤±æ•—'}`);
                
                // æª¢æŸ¥ Auth æœå‹™
                if (auth) {
                    log('âœ… Firebase Auth å·²åˆå§‹åŒ–');
                    log(`ç•¶å‰ç”¨æˆ¶: ${auth.currentUser ? auth.currentUser.email : 'ç„¡'}`);
                } else {
                    log('âŒ Firebase Auth æœªåˆå§‹åŒ–');
                }
                
                showStatus('Firebase ç‹€æ…‹æª¢æŸ¥å®Œæˆ', 'success');
                
            } catch (error) {
                log(`âŒ Firebase ç‹€æ…‹æª¢æŸ¥å¤±æ•—: ${error.message}`);
                showStatus(`æª¢æŸ¥å¤±æ•—: ${error.message}`, 'error');
            }
        };

        // æ¸¬è©¦å½ˆå‡ºè¦–çª—ç™»å…¥
        window.testPopupLogin = async function() {
            try {
                log('=== æ¸¬è©¦å½ˆå‡ºè¦–çª—ç™»å…¥ ===');
                
                if (!authModule) throw new Error('Auth æ¨¡çµ„æœªè¼‰å…¥');
                
                const { GoogleAuthProvider, signInWithPopup } = authModule;
                const provider = new GoogleAuthProvider();
                provider.addScope('email');
                provider.addScope('profile');
                
                log('ç™¼é€å½ˆå‡ºè¦–çª—ç™»å…¥è«‹æ±‚...');
                showStatus('æ­£åœ¨é–‹å•Ÿç™»å…¥è¦–çª—...', 'info');
                
                const result = await signInWithPopup(auth, provider);
                
                if (result && result.user) {
                    log(`âœ… å½ˆå‡ºè¦–çª—ç™»å…¥æˆåŠŸ: ${result.user.email}`);
                    showStatus(`ç™»å…¥æˆåŠŸ: ${result.user.email}`, 'success');
                } else {
                    log('âŒ å½ˆå‡ºè¦–çª—ç™»å…¥å¤±æ•—: æ²’æœ‰çµæœ');
                    showStatus('ç™»å…¥å¤±æ•—: æ²’æœ‰çµæœ', 'error');
                }
                
            } catch (error) {
                log(`âŒ å½ˆå‡ºè¦–çª—ç™»å…¥å¤±æ•—: ${error.code} - ${error.message}`);
                showStatus(`å½ˆå‡ºè¦–çª—ç™»å…¥å¤±æ•—: ${error.message}`, 'error');
            }
        };

        // æ¸¬è©¦é‡å®šå‘ç™»å…¥
        window.testRedirectLogin = async function() {
            try {
                log('=== æ¸¬è©¦é‡å®šå‘ç™»å…¥ ===');
                
                if (!authModule) throw new Error('Auth æ¨¡çµ„æœªè¼‰å…¥');
                
                const { GoogleAuthProvider, signInWithRedirect } = authModule;
                const provider = new GoogleAuthProvider();
                provider.addScope('email');
                provider.addScope('profile');
                provider.setCustomParameters({
                    'prompt': 'select_account'
                });
                
                log('ç™¼é€é‡å®šå‘ç™»å…¥è«‹æ±‚...');
                showStatus('æ­£åœ¨é‡å®šå‘åˆ° Google...', 'info');
                
                // è¨˜éŒ„å˜—è©¦
                sessionStorage.setItem('redirectLoginAttempt', Date.now().toString());
                localStorage.setItem('redirectLoginAttempt', Date.now().toString());
                
                await signInWithRedirect(auth, provider);
                log('âœ… é‡å®šå‘è«‹æ±‚å·²ç™¼é€ (é é¢æ‡‰è©²è·³è½‰)');
                
            } catch (error) {
                log(`âŒ é‡å®šå‘ç™»å…¥å¤±æ•—: ${error.code} - ${error.message}`);
                showStatus(`é‡å®šå‘ç™»å…¥å¤±æ•—: ${error.message}`, 'error');
            }
        };

        // ç›´æ¥é‡å®šå‘ (è·³éæª¢æŸ¥)
        window.testDirectRedirect = async function() {
            try {
                log('=== ç›´æ¥é‡å®šå‘æ¸¬è©¦ ===');
                
                const clientId = '656225813708-å…·é«”çš„client_id.apps.googleusercontent.com';
                const redirectUri = encodeURIComponent(window.location.origin + '/accounting/ultimate-debug.html');
                const scope = encodeURIComponent('email profile');
                
                const googleOAuthUrl = `https://accounts.google.com/o/oauth2/v2/auth?` +
                    `client_id=${clientId}&` +
                    `redirect_uri=${redirectUri}&` +
                    `response_type=code&` +
                    `scope=${scope}&` +
                    `prompt=select_account`;
                
                log(`ç›´æ¥é‡å®šå‘ URL: ${googleOAuthUrl}`);
                showStatus('æ­£åœ¨è·³è½‰åˆ° Google (ç›´æ¥æ–¹å¼)...', 'info');
                
                sessionStorage.setItem('directRedirectAttempt', Date.now().toString());
                
                window.location.href = googleOAuthUrl;
                
            } catch (error) {
                log(`âŒ ç›´æ¥é‡å®šå‘å¤±æ•—: ${error.message}`);
                showStatus(`ç›´æ¥é‡å®šå‘å¤±æ•—: ${error.message}`, 'error');
            }
        };

        // ç›´æ¥é–‹å•Ÿ Google OAuth
        window.openGoogleDirectly = function() {
            const googleOAuthBase = 'https://accounts.google.com/o/oauth2/v2/auth';
            const params = new URLSearchParams({
                client_id: '656225813708-ä½ çš„å®Œæ•´client_id.apps.googleusercontent.com',
                redirect_uri: window.location.origin + window.location.pathname,
                response_type: 'code',
                scope: 'email profile',
                prompt: 'select_account'
            });
            
            const url = `${googleOAuthBase}?${params.toString()}`;
            log(`Google OAuth URL: ${url}`);
            
            // åœ¨æ–°è¦–çª—é–‹å•Ÿçœ‹çœ‹æ˜¯å¦æœ‰éŒ¯èª¤
            const popup = window.open(url, 'google_oauth', 'width=500,height=600');
            
            if (!popup) {
                log('âŒ ç„¡æ³•é–‹å•Ÿå½ˆå‡ºè¦–çª— - å¯èƒ½è¢«é˜»æ“‹');
                showStatus('å½ˆå‡ºè¦–çª—è¢«é˜»æ“‹', 'error');
            } else {
                log('âœ… Google OAuth è¦–çª—å·²é–‹å•Ÿ');
                showStatus('Google OAuth è¦–çª—å·²é–‹å•Ÿ', 'info');
            }
        };

        // æª¢æŸ¥ç•¶å‰èªè­‰ç‹€æ…‹
        window.checkCurrentAuth = function() {
            log('=== æª¢æŸ¥ç•¶å‰èªè­‰ç‹€æ…‹ ===');
            
            if (auth && auth.currentUser) {
                const user = auth.currentUser;
                log(`âœ… ç•¶å‰ç”¨æˆ¶: ${user.email}`);
                log(`- é¡¯ç¤ºåç¨±: ${user.displayName}`);
                log(`- UID: ${user.uid}`);
                log(`- ä¿¡ç®±é©—è­‰: ${user.emailVerified}`);
                showStatus(`å·²ç™»å…¥: ${user.email}`, 'success');
            } else {
                log('âŒ ç•¶å‰æ²’æœ‰ç”¨æˆ¶');
                showStatus('æœªç™»å…¥', 'info');
            }
            
            // æª¢æŸ¥ session storage
            const sessionAttempt = sessionStorage.getItem('redirectLoginAttempt');
            const localAttempt = localStorage.getItem('redirectLoginAttempt');
            
            if (sessionAttempt) log(`Session ç™»å…¥å˜—è©¦: ${new Date(parseInt(sessionAttempt))}`);
            if (localAttempt) log(`Local ç™»å…¥å˜—è©¦: ${new Date(parseInt(localAttempt))}`);
        };

        // æª¢æŸ¥é‡å®šå‘çµæœ
        window.checkRedirectResult = async function() {
            try {
                log('=== æª¢æŸ¥é‡å®šå‘çµæœ ===');
                
                if (!authModule) throw new Error('Auth æ¨¡çµ„æœªè¼‰å…¥');
                
                const { getRedirectResult } = authModule;
                
                log('å‘¼å« getRedirectResult...');
                const result = await getRedirectResult(auth);
                
                if (result && result.user) {
                    log(`âœ… ç™¼ç¾é‡å®šå‘çµæœ: ${result.user.email}`);
                    log(`- é¡¯ç¤ºåç¨±: ${result.user.displayName}`);
                    log(`- UID: ${result.user.uid}`);
                    showStatus(`é‡å®šå‘ç™»å…¥æˆåŠŸ: ${result.user.email}`, 'success');
                    
                    // æ¸…é™¤å˜—è©¦è¨˜éŒ„
                    sessionStorage.removeItem('redirectLoginAttempt');
                    localStorage.removeItem('redirectLoginAttempt');
                    
                } else {
                    log('â„¹ï¸ æ²’æœ‰é‡å®šå‘çµæœ');
                    showStatus('æ²’æœ‰é‡å®šå‘çµæœ', 'warning');
                    
                    // æª¢æŸ¥æ˜¯å¦æœ‰å˜—è©¦è¨˜éŒ„ä½†æ²’æœ‰çµæœ
                    const sessionAttempt = sessionStorage.getItem('redirectLoginAttempt');
                    const localAttempt = localStorage.getItem('redirectLoginAttempt');
                    
                    if (sessionAttempt || localAttempt) {
                        log('âš ï¸ æœ‰ç™»å…¥å˜—è©¦è¨˜éŒ„ä½†æ²’æœ‰é‡å®šå‘çµæœ - å¯èƒ½ç™»å…¥å¤±æ•—');
                        showStatus('ç™»å…¥å¯èƒ½å¤±æ•— - æœ‰å˜—è©¦è¨˜éŒ„ä½†ç„¡çµæœ', 'error');
                    }
                }
                
            } catch (error) {
                log(`âŒ æª¢æŸ¥é‡å®šå‘çµæœå¤±æ•—: ${error.code} - ${error.message}`);
                showStatus(`æª¢æŸ¥å¤±æ•—: ${error.message}`, 'error');
            }
        };

        // æ¸…é™¤æ‰€æœ‰è³‡æ–™
        window.clearAllData = async function() {
            try {
                log('=== æ¸…é™¤æ‰€æœ‰è³‡æ–™ ===');
                
                // ç™»å‡º
                if (auth && auth.currentUser) {
                    const { signOut } = authModule;
                    await signOut(auth);
                    log('âœ… å·²ç™»å‡º');
                }
                
                // æ¸…é™¤å„²å­˜
                sessionStorage.clear();
                localStorage.clear();
                log('âœ… å·²æ¸…é™¤æ‰€æœ‰å„²å­˜');
                
                // æ¸…é™¤ cookies
                document.cookie.split(";").forEach(function(c) { 
                    document.cookie = c.replace(/^ +/, "").replace(/=.*/, "=;expires=" + new Date().toUTCString() + ";path=/"); 
                });
                log('âœ… å·²æ¸…é™¤ cookies');
                
                showStatus('æ‰€æœ‰è³‡æ–™å·²æ¸…é™¤', 'success');
                
                // é‡æ–°è¼‰å…¥é é¢
                setTimeout(() => {
                    location.reload();
                }, 1500);
                
            } catch (error) {
                log(`âŒ æ¸…é™¤è³‡æ–™å¤±æ•—: ${error.message}`);
                showStatus(`æ¸…é™¤å¤±æ•—: ${error.message}`, 'error');
            }
        };

        // é é¢è¼‰å…¥æ™‚åŸ·è¡Œ
        window.addEventListener('load', async () => {
            log('=== çµ‚æ¥µè¨ºæ–·å·¥å…·å•Ÿå‹• ===');
            detectDevice();
            
            const success = await initFirebase();
            if (success) {
                // è‡ªå‹•æª¢æŸ¥é‡å®šå‘çµæœ
                setTimeout(() => {
                    checkRedirectResult();
                }, 1000);
            }
        });

    </script>
</body>
</html>

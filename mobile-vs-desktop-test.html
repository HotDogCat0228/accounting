<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ‰‹æ©Ÿ vs é›»è…¦ç™»å…¥å·®ç•°æ¸¬è©¦</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            min-height: 100vh;
            padding: 15px;
        }
        .container {
            max-width: 500px;
            margin: 0 auto;
            background: rgba(255,255,255,0.1);
            padding: 20px;
            border-radius: 15px;
            backdrop-filter: blur(10px);
        }
        h1 { text-align: center; margin-bottom: 20px; font-size: 18px; }
        .section {
            background: rgba(255,255,255,0.1);
            padding: 15px;
            margin: 15px 0;
            border-radius: 10px;
        }
        .section h3 {
            margin-bottom: 10px;
            color: #ffd700;
            font-size: 14px;
        }
        button {
            width: 100%;
            padding: 12px;
            margin: 6px 0;
            border: none;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            background: white;
            color: #333;
        }
        .popup-btn { background: #4CAF50; color: white; }
        .redirect-btn { background: #2196F3; color: white; }
        .test-btn { background: #FF9800; color: white; }
        button:disabled { opacity: 0.5; }
        .log {
            background: rgba(0,0,0,0.4);
            padding: 12px;
            margin: 10px 0;
            border-radius: 8px;
            font-family: monospace;
            font-size: 11px;
            max-height: 180px;
            overflow-y: auto;
            white-space: pre-wrap;
        }
        .status {
            padding: 10px;
            margin: 8px 0;
            border-radius: 6px;
            font-weight: bold;
            font-size: 13px;
        }
        .success { background: rgba(76,175,80,0.9); }
        .error { background: rgba(244,67,54,0.9); }
        .info { background: rgba(33,150,243,0.9); }
        .warning { background: rgba(255,152,0,0.9); }
        .device-info {
            font-size: 12px;
            background: rgba(0,0,0,0.2);
            padding: 10px;
            border-radius: 5px;
            margin-bottom: 15px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ“±ğŸ’» æ‰‹æ©Ÿ vs é›»è…¦ç™»å…¥è¨ºæ–·</h1>
        
        <div class="device-info" id="deviceInfo">
            æª¢æ¸¬ä¸­...
        </div>
        
        <div class="section">
            <h3>ğŸ” ç™»å…¥æ–¹å¼æ¸¬è©¦</h3>
            <button class="popup-btn" onclick="testPopup()">æ¸¬è©¦å½ˆå‡ºè¦–çª—ç™»å…¥ (é›»è…¦æ–¹å¼)</button>
            <button class="redirect-btn" onclick="testRedirect()">æ¸¬è©¦é‡å®šå‘ç™»å…¥ (æ‰‹æ©Ÿæ–¹å¼)</button>
            <button class="test-btn" onclick="testBoth()">è‡ªå‹•æ¸¬è©¦æœ€ä½³æ–¹å¼</button>
        </div>
        
        <div class="section">
            <h3>ğŸ”§ é€²éšè¨ºæ–·</h3>
            <button onclick="checkPopupBlocking()">æª¢æŸ¥å½ˆå‡ºè¦–çª—é˜»æ“‹</button>
            <button onclick="testRedirectFlow()">æ¸¬è©¦é‡å®šå‘æµç¨‹</button>
            <button onclick="checkSessionStorage()">æª¢æŸ¥ç™»å…¥ç‹€æ…‹</button>
            <button onclick="simulateMobileRedirect()">æ¨¡æ“¬æ‰‹æ©Ÿé‡å®šå‘</button>
        </div>
        
        <div id="status"></div>
        <div class="log" id="log"></div>
    </div>

    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
        import { 
            getAuth, 
            GoogleAuthProvider, 
            signInWithPopup, 
            signInWithRedirect, 
            getRedirectResult,
            onAuthStateChanged,
            signOut
        } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js';
        
        const firebaseConfig = {
            apiKey: "AIzaSyB1DXR1TC11ZDhIXAeyWyn0gXnxaYW6Cjs",
            authDomain: "my-wallet-app-815ce.firebaseapp.com",
            projectId: "my-wallet-app-815ce",
            storageBucket: "my-wallet-app-815ce.firebasestorage.app",
            messagingSenderId: "656225813708",
            appId: "1:656225813708:web:2acd800eedd53408b4ae69"
        };
        
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        
        let deviceInfo = {};
        
        function log(message, type = 'info') {
            const logDiv = document.getElementById('log');
            const timestamp = new Date().toLocaleTimeString();
            const color = type === 'error' ? '#ff6b6b' : 
                         type === 'success' ? '#51cf66' : 
                         type === 'warning' ? '#ffd43b' : '#74c0fc';
            logDiv.innerHTML += `<div style="color: ${color}">[${timestamp}] ${message}</div>`;
            logDiv.scrollTop = logDiv.scrollHeight;
            console.log(message);
        }
        
        function showStatus(message, type = 'info') {
            const statusDiv = document.getElementById('status');
            statusDiv.innerHTML = `<div class="status ${type}">${message}</div>`;
        }
        
        function detectDevice() {
            const ua = navigator.userAgent;
            deviceInfo = {
                userAgent: ua,
                isMobile: /Android|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(ua),
                isIOS: /iPad|iPhone|iPod/.test(ua),
                isAndroid: /Android/i.test(ua),
                isSafari: /Safari/.test(ua) && !/Chrome/.test(ua),
                isChrome: /Chrome/.test(ua),
                isFirefox: /Firefox/.test(ua),
                isStandalone: window.matchMedia('(display-mode: standalone)').matches || window.navigator.standalone,
                screenWidth: screen.width,
                screenHeight: screen.height,
                viewportWidth: window.innerWidth,
                viewportHeight: window.innerHeight,
                touchSupport: 'ontouchstart' in window,
                cookieEnabled: navigator.cookieEnabled,
                onlineStatus: navigator.onLine
            };
            
            const deviceDiv = document.getElementById('deviceInfo');
            deviceDiv.innerHTML = `
                ğŸ“± è¨­å‚™: ${deviceInfo.isMobile ? 'æ‰‹æ©Ÿ' : 'é›»è…¦'} | 
                ğŸ¯ ç³»çµ±: ${deviceInfo.isIOS ? 'iOS' : deviceInfo.isAndroid ? 'Android' : 'å…¶ä»–'} | 
                ğŸŒ ç€è¦½å™¨: ${deviceInfo.isSafari ? 'Safari' : deviceInfo.isChrome ? 'Chrome' : deviceInfo.isFirefox ? 'Firefox' : 'å…¶ä»–'}<br>
                ğŸ“ è¢å¹•: ${deviceInfo.screenWidth}x${deviceInfo.screenHeight} | 
                ğŸ‘† è§¸æ§: ${deviceInfo.touchSupport ? 'æ”¯æ´' : 'ä¸æ”¯æ´'} | 
                ğŸš€ PWA: ${deviceInfo.isStandalone ? 'æ˜¯' : 'å¦'} | 
                ğŸª Cookie: ${deviceInfo.cookieEnabled ? 'âœ“' : 'âœ—'}
            `;
            
            log(`è¨­å‚™æª¢æ¸¬: ${JSON.stringify(deviceInfo, null, 2)}`);
            return deviceInfo;
        }
        
        // æ¸¬è©¦å½ˆå‡ºè¦–çª—ç™»å…¥
        window.testPopup = async function() {
            try {
                log('=== æ¸¬è©¦å½ˆå‡ºè¦–çª—ç™»å…¥ ===', 'info');
                showStatus('æ­£åœ¨æ¸¬è©¦å½ˆå‡ºè¦–çª—ç™»å…¥...', 'info');
                
                const provider = new GoogleAuthProvider();
                provider.addScope('email');
                provider.addScope('profile');
                
                log('ç™¼é€å½ˆå‡ºè¦–çª—è«‹æ±‚...');
                const result = await signInWithPopup(auth, provider);
                
                if (result && result.user) {
                    log(`âœ… å½ˆå‡ºè¦–çª—ç™»å…¥æˆåŠŸ: ${result.user.email}`, 'success');
                    showStatus(`å½ˆå‡ºè¦–çª—ç™»å…¥æˆåŠŸ: ${result.user.displayName || result.user.email}`, 'success');
                } else {
                    log('âŒ å½ˆå‡ºè¦–çª—ç™»å…¥å¤±æ•—: æ²’æœ‰ç”¨æˆ¶è³‡æ–™', 'error');
                    showStatus('å½ˆå‡ºè¦–çª—ç™»å…¥å¤±æ•—', 'error');
                }
                
            } catch (error) {
                log(`âŒ å½ˆå‡ºè¦–çª—ç™»å…¥éŒ¯èª¤: ${error.code} - ${error.message}`, 'error');
                
                let message = 'å½ˆå‡ºè¦–çª—ç™»å…¥å¤±æ•—';
                if (error.code === 'auth/popup-blocked') {
                    message = 'å½ˆå‡ºè¦–çª—è¢«é˜»æ“‹ - è«‹å…è¨±å½ˆå‡ºè¦–çª—';
                } else if (error.code === 'auth/popup-closed-by-user') {
                    message = 'ç”¨æˆ¶é—œé–‰äº†ç™»å…¥è¦–çª—';
                } else if (error.code === 'auth/cancelled-popup-request') {
                    message = 'å½ˆå‡ºè¦–çª—è«‹æ±‚è¢«å–æ¶ˆ - å¯èƒ½é–‹å•Ÿäº†å¤šå€‹è¦–çª—';
                }
                
                showStatus(message, 'error');
            }
        };
        
        // æ¸¬è©¦é‡å®šå‘ç™»å…¥
        window.testRedirect = async function() {
            try {
                log('=== æ¸¬è©¦é‡å®šå‘ç™»å…¥ ===', 'info');
                showStatus('æ­£åœ¨æ¸¬è©¦é‡å®šå‘ç™»å…¥...', 'info');
                
                const provider = new GoogleAuthProvider();
                provider.addScope('email');
                provider.addScope('profile');
                provider.setCustomParameters({
                    'prompt': 'select_account'
                });
                
                log('è¨˜éŒ„é‡å®šå‘å˜—è©¦...');
                sessionStorage.setItem('redirectTest', JSON.stringify({
                    timestamp: Date.now(),
                    userAgent: navigator.userAgent,
                    method: 'redirect'
                }));
                
                log('ç™¼é€é‡å®šå‘è«‹æ±‚...');
                showStatus('æ­£åœ¨è·³è½‰åˆ° Google...', 'info');
                
                await signInWithRedirect(auth, provider);
                log('âœ… é‡å®šå‘è«‹æ±‚å·²ç™¼é€ (é é¢å°‡è·³è½‰)');
                
            } catch (error) {
                log(`âŒ é‡å®šå‘ç™»å…¥éŒ¯èª¤: ${error.code} - ${error.message}`, 'error');
                
                let message = 'é‡å®šå‘ç™»å…¥å¤±æ•—';
                if (error.code === 'auth/operation-not-allowed') {
                    message = 'Google ç™»å…¥æœªå•Ÿç”¨ - æª¢æŸ¥ Firebase è¨­å®š';
                } else if (error.code === 'auth/unauthorized-domain') {
                    message = 'ç¶²åŸŸæœªæˆæ¬Š - æª¢æŸ¥ Firebase æˆæ¬Šç¶²åŸŸ';
                }
                
                showStatus(message, 'error');
            }
        };
        
        // è‡ªå‹•æ¸¬è©¦æœ€ä½³æ–¹å¼
        window.testBoth = async function() {
            log('=== è‡ªå‹•æ¸¬è©¦æœ€ä½³ç™»å…¥æ–¹å¼ ===', 'info');
            
            if (deviceInfo.isMobile || deviceInfo.isStandalone) {
                log('æª¢æ¸¬åˆ°æ‰‹æ©Ÿæˆ–PWAç’°å¢ƒï¼Œä½¿ç”¨é‡å®šå‘ç™»å…¥', 'info');
                testRedirect();
            } else {
                log('æª¢æ¸¬åˆ°æ¡Œé¢ç’°å¢ƒï¼Œä½¿ç”¨å½ˆå‡ºè¦–çª—ç™»å…¥', 'info');
                testPopup();
            }
        };
        
        // æª¢æŸ¥å½ˆå‡ºè¦–çª—é˜»æ“‹
        window.checkPopupBlocking = function() {
            log('=== æª¢æŸ¥å½ˆå‡ºè¦–çª—é˜»æ“‹ ===', 'info');
            
            try {
                const popup = window.open('', 'test', 'width=1,height=1');
                if (popup) {
                    popup.close();
                    log('âœ… å½ˆå‡ºè¦–çª—æ²’æœ‰è¢«é˜»æ“‹', 'success');
                    showStatus('å½ˆå‡ºè¦–çª—æ­£å¸¸', 'success');
                } else {
                    log('âŒ å½ˆå‡ºè¦–çª—è¢«é˜»æ“‹', 'error');
                    showStatus('å½ˆå‡ºè¦–çª—è¢«é˜»æ“‹', 'error');
                }
            } catch (error) {
                log(`âŒ å½ˆå‡ºè¦–çª—æ¸¬è©¦å¤±æ•—: ${error.message}`, 'error');
                showStatus('å½ˆå‡ºè¦–çª—æ¸¬è©¦å¤±æ•—', 'error');
            }
        };
        
        // æ¸¬è©¦é‡å®šå‘æµç¨‹
        window.testRedirectFlow = async function() {
            try {
                log('=== æ¸¬è©¦é‡å®šå‘æµç¨‹ ===', 'info');
                
                // æª¢æŸ¥æ˜¯å¦æœ‰é‡å®šå‘çµæœ
                log('æª¢æŸ¥é‡å®šå‘çµæœ...');
                const result = await getRedirectResult(auth);
                
                if (result && result.user) {
                    log(`âœ… ç™¼ç¾é‡å®šå‘ç™»å…¥çµæœ: ${result.user.email}`, 'success');
                    showStatus(`é‡å®šå‘ç™»å…¥æˆåŠŸ: ${result.user.email}`, 'success');
                    
                    // æ¸…é™¤æ¸¬è©¦è¨˜éŒ„
                    sessionStorage.removeItem('redirectTest');
                } else {
                    log('â„¹ï¸ æ²’æœ‰é‡å®šå‘çµæœ', 'info');
                    
                    // æª¢æŸ¥æ˜¯å¦æœ‰ä¹‹å‰çš„å˜—è©¦è¨˜éŒ„
                    const redirectTest = sessionStorage.getItem('redirectTest');
                    if (redirectTest) {
                        const testData = JSON.parse(redirectTest);
                        const elapsed = Date.now() - testData.timestamp;
                        log(`âš ï¸ ç™¼ç¾ ${Math.round(elapsed/1000)} ç§’å‰çš„é‡å®šå‘å˜—è©¦è¨˜éŒ„ï¼Œä½†æ²’æœ‰çµæœ`, 'warning');
                        showStatus('é‡å®šå‘å˜—è©¦å¤±æ•— - å¯èƒ½è¢«é˜»æ“‹æˆ–å–æ¶ˆ', 'warning');
                    } else {
                        showStatus('æ²’æœ‰é‡å®šå‘çµæœ', 'info');
                    }
                }
                
            } catch (error) {
                log(`âŒ é‡å®šå‘æµç¨‹æ¸¬è©¦å¤±æ•—: ${error.code} - ${error.message}`, 'error');
                showStatus(`é‡å®šå‘æ¸¬è©¦å¤±æ•—: ${error.message}`, 'error');
            }
        };
        
        // æª¢æŸ¥ç™»å…¥ç‹€æ…‹
        window.checkSessionStorage = function() {
            log('=== æª¢æŸ¥ç™»å…¥ç‹€æ…‹ ===', 'info');
            
            // æª¢æŸ¥ç•¶å‰ç”¨æˆ¶
            if (auth.currentUser) {
                log(`âœ… ç•¶å‰å·²ç™»å…¥: ${auth.currentUser.email}`, 'success');
                showStatus(`å·²ç™»å…¥: ${auth.currentUser.displayName || auth.currentUser.email}`, 'success');
            } else {
                log('âŒ ç•¶å‰æœªç™»å…¥', 'info');
                showStatus('æœªç™»å…¥', 'info');
            }
            
            // æª¢æŸ¥ session storage
            for (let key in sessionStorage) {
                if (key.includes('firebase') || key.includes('redirect') || key.includes('login')) {
                    log(`Session: ${key} = ${sessionStorage[key]}`);
                }
            }
            
            // æª¢æŸ¥ local storage
            for (let key in localStorage) {
                if (key.includes('firebase') || key.includes('redirect') || key.includes('login')) {
                    log(`Local: ${key} = ${localStorage[key]}`);
                }
            }
        };
        
        // æ¨¡æ“¬æ‰‹æ©Ÿé‡å®šå‘
        window.simulateMobileRedirect = function() {
            log('=== æ¨¡æ“¬æ‰‹æ©Ÿé‡å®šå‘æµç¨‹ ===', 'info');
            
            // å‰µå»ºä¸€å€‹æ‰‹æ©Ÿç‰ˆçš„é‡å®šå‘ URL
            const provider = new GoogleAuthProvider();
            const params = new URLSearchParams({
                client_id: 'your-client-id',
                redirect_uri: window.location.href,
                response_type: 'code',
                scope: 'email profile',
                state: 'mobile_test',
                prompt: 'select_account'
            });
            
            const mobileUrl = `https://accounts.google.com/o/oauth2/v2/auth?${params.toString()}`;
            log(`æ¨¡æ“¬æ‰‹æ©Ÿé‡å®šå‘ URL: ${mobileUrl}`);
            
            // è¨˜éŒ„æ¨¡æ“¬æ¸¬è©¦
            sessionStorage.setItem('mobileSimulation', JSON.stringify({
                timestamp: Date.now(),
                url: mobileUrl
            }));
            
            showStatus('æ¨¡æ“¬æ‰‹æ©Ÿé‡å®šå‘å·²è¨˜éŒ„', 'info');
        };
        
        // è¨­å®šèªè­‰ç›£è½å™¨
        onAuthStateChanged(auth, (user) => {
            if (user) {
                log(`ğŸ‰ èªè­‰ç‹€æ…‹è®Šæ›´: ç”¨æˆ¶å·²ç™»å…¥ - ${user.email}`, 'success');
            } else {
                log('ğŸ‘¤ èªè­‰ç‹€æ…‹è®Šæ›´: ç”¨æˆ¶æœªç™»å…¥', 'info');
            }
        });
        
        // é é¢è¼‰å…¥æ™‚åŸ·è¡Œ
        window.addEventListener('load', () => {
            detectDevice();
            
            // è‡ªå‹•æª¢æŸ¥é‡å®šå‘çµæœ
            setTimeout(() => {
                testRedirectFlow();
            }, 1000);
        });
    </script>
</body>
</html>

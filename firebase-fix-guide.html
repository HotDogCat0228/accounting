<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>快速 Firebase 診斷</title>
    <style>
        body { font-family: Arial, sans-serif; padding: 20px; background: #f5f5f5; }
        .container { max-width: 600px; margin: 0 auto; background: white; padding: 20px; border-radius: 10px; }
        .error { background: #ffebee; color: #c62828; padding: 15px; border-radius: 5px; margin: 10px 0; }
        .success { background: #e8f5e8; color: #2e7d32; padding: 15px; border-radius: 5px; margin: 10px 0; }
        .warning { background: #fff3e0; color: #ef6c00; padding: 15px; border-radius: 5px; margin: 10px 0; }
        .info { background: #e3f2fd; color: #1565c0; padding: 15px; border-radius: 5px; margin: 10px 0; }
        button { padding: 15px 30px; margin: 10px 5px; border: none; border-radius: 5px; font-size: 16px; cursor: pointer; }
        .primary { background: #1976d2; color: white; }
        .secondary { background: #757575; color: white; }
        .log { background: #f8f9fa; padding: 15px; font-family: monospace; font-size: 12px; border-radius: 5px; max-height: 200px; overflow-y: auto; }
        h1 { color: #333; text-align: center; }
        h2 { color: #555; border-bottom: 2px solid #eee; padding-bottom: 10px; }
    </style>
</head>
<body>
    <div class="container">
        <h1>🔥 Firebase Google 登入問題診斷</h1>
        
        <div class="error">
            <h3>❌ 發現問題：CORS 和 404 錯誤</h3>
            <p>這表示 Firebase 專案的授權網域配置可能有問題，或者專案設定不正確。</p>
        </div>
        
        <h2>🔍 快速診斷</h2>
        <button class="primary" onclick="testGoogleAuth()">測試 Google 登入</button>
        <button class="secondary" onclick="checkDomainAuth()">檢查網域授權</button>
        <button class="secondary" onclick="testDirectGoogleOAuth()">繞過 Firebase 測試</button>
        
        <div id="results"></div>
        <div class="log" id="log"></div>
        
        <h2>🛠️ 可能的解決方案</h2>
        
        <div class="warning">
            <h4>1. Firebase 專案授權網域問題</h4>
            <p>需要在 Firebase Console 中添加授權網域：</p>
            <ul>
                <li>前往 <strong>Firebase Console → Authentication → Settings → Authorized domains</strong></li>
                <li>確認已添加：<code>hotdogcat0228.github.io</code></li>
                <li>也建議添加：<code>localhost</code> (測試用)</li>
            </ul>
        </div>
        
        <div class="info">
            <h4>2. Google Cloud Console OAuth 設定</h4>
            <p>檢查 Google Cloud Console 的 OAuth 2.0 設定：</p>
            <ul>
                <li>前往 <strong>Google Cloud Console → APIs & Services → Credentials</strong></li>
                <li>找到您的 OAuth 2.0 用戶端 ID</li>
                <li>確認「已授權的 JavaScript 來源」包含：
                    <ul>
                        <li><code>https://hotdogcat0228.github.io</code></li>
                    </ul>
                </li>
                <li>確認「已授權的重新導向 URI」包含：
                    <ul>
                        <li><code>https://hotdogcat0228.github.io/accounting</code></li>
                        <li><code>https://hotdogcat0228.github.io/accounting/</code></li>
                    </ul>
                </li>
            </ul>
        </div>
        
        <div class="warning">
            <h4>3. Firebase 專案狀態</h4>
            <p>確認 Firebase 專案正常運作：</p>
            <ul>
                <li>前往 <strong>Firebase Console → Project Settings</strong></li>
                <li>檢查專案 ID 是否正確：<code>my-wallet-app-815ce</code></li>
                <li>確認 Authentication 功能已啟用</li>
                <li>確認 Google 登入提供者已啟用</li>
            </ul>
        </div>
        
        <div class="error">
            <h4>4. 立即修復建議</h4>
            <p>請執行以下步驟：</p>
            <ol>
                <li><strong>前往 Firebase Console</strong> → 您的專案</li>
                <li><strong>Authentication</strong> → <strong>Settings</strong> → <strong>Authorized domains</strong></li>
                <li><strong>添加網域</strong>：<code>hotdogcat0228.github.io</code></li>
                <li><strong>儲存</strong>後等待 5-10 分鐘讓設定生效</li>
                <li><strong>清除瀏覽器緩存</strong>並重新測試</li>
            </ol>
        </div>
    </div>

    <script type="module">
        const firebaseConfig = {
            apiKey: "AIzaSyB1DXR1TC11ZDhIXAeyWyn0gXnxaYW6Cjs",
            authDomain: "my-wallet-app-815ce.firebaseapp.com",
            projectId: "my-wallet-app-815ce",
            storageBucket: "my-wallet-app-815ce.firebasestorage.app",
            messagingSenderId: "656225813708",
            appId: "1:656225813708:web:2acd800eedd53408b4ae69",
            measurementId: "G-Z9MECGE7T0"
        };

        let app, auth;

        function log(message, type = 'info') {
            const logDiv = document.getElementById('log');
            const timestamp = new Date().toLocaleTimeString();
            logDiv.innerHTML += `<div style="color: ${type === 'error' ? 'red' : type === 'success' ? 'green' : 'black'}">[${timestamp}] ${message}</div>`;
            logDiv.scrollTop = logDiv.scrollHeight;
            console.log(message);
        }

        function showResult(message, type = 'info') {
            const resultsDiv = document.getElementById('results');
            const className = type;
            resultsDiv.innerHTML += `<div class="${className}"><strong>${type.toUpperCase()}:</strong> ${message}</div>`;
        }

        async function initFirebase() {
            try {
                const { initializeApp } = await import('https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js');
                const { getAuth } = await import('https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js');
                
                app = initializeApp(firebaseConfig);
                auth = getAuth(app);
                
                log('Firebase 初始化成功', 'success');
                return true;
            } catch (error) {
                log(`Firebase 初始化失敗: ${error.message}`, 'error');
                showResult(`Firebase 初始化失敗: ${error.message}`, 'error');
                return false;
            }
        }

        window.testGoogleAuth = async function() {
            try {
                log('=== 測試 Google 登入 ===');
                
                if (!auth) {
                    const success = await initFirebase();
                    if (!success) return;
                }
                
                const { GoogleAuthProvider, signInWithRedirect } = await import('https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js');
                
                const provider = new GoogleAuthProvider();
                provider.addScope('email');
                provider.addScope('profile');
                
                log('發送重定向請求...');
                showResult('正在嘗試重定向到 Google...', 'info');
                
                await signInWithRedirect(auth, provider);
                log('重定向請求已發送', 'success');
                
            } catch (error) {
                log(`Google 登入測試失敗: ${error.code} - ${error.message}`, 'error');
                
                if (error.code === 'auth/unauthorized-domain') {
                    showResult('❌ 授權網域錯誤：請在 Firebase Console 中添加 hotdogcat0228.github.io 到授權網域列表', 'error');
                } else if (error.code === 'auth/operation-not-allowed') {
                    showResult('❌ 操作不允許：請在 Firebase Console 中啟用 Google 登入提供者', 'error');
                } else {
                    showResult(`Google 登入錯誤: ${error.message}`, 'error');
                }
            }
        };

        window.checkDomainAuth = function() {
            log('=== 檢查網域授權 ===');
            
            const currentDomain = window.location.hostname;
            const currentOrigin = window.location.origin;
            
            log(`當前網域: ${currentDomain}`);
            log(`當前來源: ${currentOrigin}`);
            log(`Firebase Auth Domain: ${firebaseConfig.authDomain}`);
            
            const expectedDomains = [
                'hotdogcat0228.github.io',
                'localhost',
                '127.0.0.1'
            ];
            
            if (expectedDomains.includes(currentDomain)) {
                showResult(`✅ 當前網域 (${currentDomain}) 應該被授權`, 'success');
                log('網域檢查通過', 'success');
            } else {
                showResult(`❌ 當前網域 (${currentDomain}) 可能未被授權`, 'error');
                log('網域檢查失敗', 'error');
            }
            
            showResult(`請確認在 Firebase Console → Authentication → Settings → Authorized domains 中已添加: ${currentDomain}`, 'warning');
        };

        window.testDirectGoogleOAuth = function() {
            log('=== 繞過 Firebase 測試 Google OAuth ===');
            
            // 這會開啟 Google OAuth 頁面，但不會完成登入流程
            // 主要是測試 OAuth 配置是否正確
            const baseUrl = 'https://accounts.google.com/o/oauth2/v2/auth';
            const params = new URLSearchParams({
                client_id: '656225813708', // 這是不完整的 client_id，僅用於測試
                redirect_uri: window.location.origin + window.location.pathname,
                response_type: 'code',
                scope: 'email profile',
                state: 'test_state'
            });
            
            const testUrl = `${baseUrl}?${params.toString()}`;
            log(`測試 URL: ${testUrl}`);
            
            showResult('正在開啟 Google OAuth 測試頁面...', 'info');
            
            // 在新分頁開啟
            window.open(testUrl, '_blank');
            
            showResult('如果 Google OAuth 頁面開啟但顯示錯誤，表示 OAuth 設定有問題', 'warning');
        };

        // 頁面載入時檢查
        window.addEventListener('load', () => {
            log('頁面載入完成');
            checkDomainAuth();
        });
    </script>
</body>
</html>

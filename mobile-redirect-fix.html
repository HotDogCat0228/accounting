<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>手機重定向修復方案</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            min-height: 100vh;
            padding: 15px;
        }
        .container {
            max-width: 500px;
            margin: 0 auto;
            background: rgba(255,255,255,0.1);
            padding: 20px;
            border-radius: 15px;
            backdrop-filter: blur(10px);
        }
        h1 { text-align: center; margin-bottom: 20px; font-size: 18px; }
        .solution {
            background: rgba(255,255,255,0.15);
            padding: 15px;
            margin: 15px 0;
            border-radius: 10px;
            border-left: 4px solid #ffd700;
        }
        .solution h3 {
            color: #ffd700;
            font-size: 14px;
            margin-bottom: 8px;
        }
        button {
            width: 100%;
            padding: 12px;
            margin: 8px 0;
            border: none;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
        }
        .primary { background: #4CAF50; color: white; }
        .secondary { background: #2196F3; color: white; }
        .warning { background: #FF9800; color: white; }
        .danger { background: #f44336; color: white; }
        button:hover { transform: translateY(-1px); }
        .log {
            background: rgba(0,0,0,0.4);
            padding: 12px;
            margin: 10px 0;
            border-radius: 8px;
            font-family: monospace;
            font-size: 11px;
            max-height: 150px;
            overflow-y: auto;
            white-space: pre-wrap;
        }
        .status {
            padding: 10px;
            margin: 8px 0;
            border-radius: 6px;
            font-weight: bold;
            font-size: 13px;
        }
        .success { background: rgba(76,175,80,0.9); }
        .error { background: rgba(244,67,54,0.9); }
        .info { background: rgba(33,150,243,0.9); }
        .warning-status { background: rgba(255,152,0,0.9); }
    </style>
</head>
<body>
    <div class="container">
        <h1>🔧 手機重定向登入修復</h1>
        
        <div class="solution">
            <h3>🎯 問題確認</h3>
            <p>您的重定向登入被阻擋，這在 iOS Safari 很常見。以下是幾個解決方案：</p>
        </div>
        
        <div class="solution">
            <h3>🚀 解決方案 1：用戶手勢觸發</h3>
            <p>重定向必須由真實的用戶點擊觸發，不能是程式自動執行</p>
            <button class="primary" onclick="userTriggeredRedirect()">👆 用戶點擊觸發重定向</button>
        </div>
        
        <div class="solution">
            <h3>🪟 解決方案 2：新視窗重定向</h3>
            <p>在新視窗中開啟登入，避免主頁面被阻擋</p>
            <button class="secondary" onclick="newWindowRedirect()">🆕 新視窗重定向登入</button>
        </div>
        
        <div class="solution">
            <h3>🔄 解決方案 3：彈出視窗降級</h3>
            <p>嘗試彈出視窗，如果失敗則降級為重定向</p>
            <button class="warning" onclick="popupFallbackRedirect()">🔄 智能登入模式</button>
        </div>
        
        <div class="solution">
            <h3>🌐 解決方案 4：直接 OAuth URL</h3>
            <p>繞過 Firebase，直接使用 Google OAuth URL</p>
            <button class="danger" onclick="directOAuthRedirect()">🌐 直接 OAuth 登入</button>
        </div>
        
        <div class="solution">
            <h3>🔍 診斷工具</h3>
            <button onclick="testUserGesture()">測試用戶手勢</button>
            <button onclick="testPopupSupport()">測試彈出視窗支援</button>
            <button onclick="checkSafariRestrictions()">檢查 Safari 限制</button>
            <button onclick="clearAllAndRetry()">清除資料重試</button>
        </div>
        
        <div id="status"></div>
        <div class="log" id="log"></div>
    </div>

    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
        import { 
            getAuth, 
            GoogleAuthProvider, 
            signInWithPopup, 
            signInWithRedirect, 
            getRedirectResult,
            onAuthStateChanged
        } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js';
        
        const firebaseConfig = {
            apiKey: "AIzaSyB1DXR1TC11ZDhIXAeyWyn0gXnxaYW6Cjs",
            authDomain: "my-wallet-app-815ce.firebaseapp.com",
            projectId: "my-wallet-app-815ce",
            storageBucket: "my-wallet-app-815ce.firebasestorage.app",
            messagingSenderId: "656225813708",
            appId: "1:656225813708:web:2acd800eedd53408b4ae69"
        };
        
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        
        function log(message, type = 'info') {
            const logDiv = document.getElementById('log');
            const timestamp = new Date().toLocaleTimeString();
            const color = type === 'error' ? '#ff6b6b' : 
                         type === 'success' ? '#51cf66' : 
                         type === 'warning' ? '#ffd43b' : '#74c0fc';
            logDiv.innerHTML += `<div style="color: ${color}">[${timestamp}] ${message}</div>`;
            logDiv.scrollTop = logDiv.scrollHeight;
            console.log(message);
        }
        
        function showStatus(message, type = 'info') {
            const statusDiv = document.getElementById('status');
            const className = type === 'warning' ? 'warning-status' : type;
            statusDiv.innerHTML = `<div class="status ${className}">${message}</div>`;
        }
        
        // 解決方案 1：用戶手勢觸發重定向
        window.userTriggeredRedirect = async function() {
            try {
                log('=== 用戶手勢觸發重定向 ===', 'info');
                showStatus('正在使用用戶手勢觸發重定向...', 'info');
                
                // 確保這是真實的用戶手勢觸發
                if (!event || !event.isTrusted) {
                    throw new Error('非真實用戶手勢');
                }
                
                const provider = new GoogleAuthProvider();
                provider.addScope('email');
                provider.addScope('profile');
                provider.setCustomParameters({
                    'prompt': 'select_account'
                });
                
                // 記錄嘗試
                sessionStorage.setItem('userGestureRedirect', JSON.stringify({
                    timestamp: Date.now(),
                    userAgent: navigator.userAgent
                }));
                
                log('執行用戶手勢重定向...');
                await signInWithRedirect(auth, provider);
                log('✅ 重定向已觸發', 'success');
                
            } catch (error) {
                log(`❌ 用戶手勢重定向失敗: ${error.message}`, 'error');
                showStatus(`重定向失敗: ${error.message}`, 'error');
            }
        };
        
        // 解決方案 2：新視窗重定向
        window.newWindowRedirect = function() {
            try {
                log('=== 新視窗重定向 ===', 'info');
                showStatus('正在開啟新視窗進行登入...', 'info');
                
                // 建構 OAuth URL
                const baseUrl = 'https://accounts.google.com/o/oauth2/v2/auth';
                const clientId = '656225813708-your-full-client-id.apps.googleusercontent.com'; // 需要完整的 client ID
                const redirectUri = encodeURIComponent(window.location.origin + '/accounting/');
                const scope = encodeURIComponent('email profile');
                const state = encodeURIComponent(JSON.stringify({
                    method: 'newWindow',
                    timestamp: Date.now()
                }));
                
                const oauthUrl = `${baseUrl}?` +
                    `client_id=${clientId}&` +
                    `redirect_uri=${redirectUri}&` +
                    `response_type=code&` +
                    `scope=${scope}&` +
                    `state=${state}&` +
                    `prompt=select_account`;
                
                log(`OAuth URL: ${oauthUrl}`);
                
                // 在新視窗開啟
                const newWindow = window.open(oauthUrl, 'googleLogin', 'width=500,height=600,scrollbars=yes,resizable=yes');
                
                if (!newWindow) {
                    throw new Error('無法開啟新視窗，可能被彈出視窗阻擋器阻擋');
                }
                
                log('✅ 新視窗已開啟', 'success');
                showStatus('請在新視窗中完成登入', 'info');
                
                // 監聽新視窗關閉
                const checkClosed = setInterval(() => {
                    if (newWindow.closed) {
                        clearInterval(checkClosed);
                        log('新視窗已關閉，檢查登入狀態...', 'info');
                        setTimeout(() => {
                            checkRedirectResult();
                        }, 1000);
                    }
                }, 1000);
                
            } catch (error) {
                log(`❌ 新視窗重定向失敗: ${error.message}`, 'error');
                showStatus(`新視窗失敗: ${error.message}`, 'error');
            }
        };
        
        // 解決方案 3：彈出視窗降級
        window.popupFallbackRedirect = async function() {
            try {
                log('=== 智能登入模式 ===', 'info');
                showStatus('正在嘗試最佳登入方式...', 'info');
                
                const provider = new GoogleAuthProvider();
                provider.addScope('email');
                provider.addScope('profile');
                
                try {
                    // 先嘗試彈出視窗
                    log('嘗試彈出視窗登入...');
                    const result = await signInWithPopup(auth, provider);
                    
                    if (result && result.user) {
                        log(`✅ 彈出視窗登入成功: ${result.user.email}`, 'success');
                        showStatus(`登入成功: ${result.user.email}`, 'success');
                        return;
                    }
                    
                } catch (popupError) {
                    log(`彈出視窗失敗: ${popupError.code} - 降級為重定向`, 'warning');
                    
                    // 彈出視窗失敗，降級為重定向
                    if (popupError.code === 'auth/popup-blocked' || 
                        popupError.code === 'auth/cancelled-popup-request') {
                        
                        log('執行降級重定向...', 'info');
                        showStatus('彈出視窗被阻擋，轉為重定向模式...', 'warning');
                        
                        provider.setCustomParameters({
                            'prompt': 'select_account'
                        });
                        
                        await signInWithRedirect(auth, provider);
                        log('✅ 降級重定向已觸發', 'success');
                        
                    } else {
                        throw popupError;
                    }
                }
                
            } catch (error) {
                log(`❌ 智能登入失敗: ${error.code} - ${error.message}`, 'error');
                showStatus(`智能登入失敗: ${error.message}`, 'error');
            }
        };
        
        // 解決方案 4：直接 OAuth URL
        window.directOAuthRedirect = function() {
            try {
                log('=== 直接 OAuth 重定向 ===', 'info');
                showStatus('使用直接 OAuth 方式...', 'info');
                
                // 這需要完整的 Google OAuth 設定
                // 注意：這會繞過 Firebase，需要手動處理回傳的授權碼
                
                const baseUrl = 'https://accounts.google.com/o/oauth2/v2/auth';
                const params = new URLSearchParams({
                    client_id: '656225813708-your-complete-client-id.apps.googleusercontent.com',
                    redirect_uri: window.location.href,
                    response_type: 'code',
                    scope: 'email profile',
                    state: 'direct_oauth',
                    prompt: 'select_account'
                });
                
                const directUrl = `${baseUrl}?${params.toString()}`;
                
                log(`直接跳轉到: ${directUrl}`);
                sessionStorage.setItem('directOAuth', Date.now().toString());
                
                // 直接跳轉
                window.location.href = directUrl;
                
            } catch (error) {
                log(`❌ 直接 OAuth 失敗: ${error.message}`, 'error');
                showStatus(`直接 OAuth 失敗: ${error.message}`, 'error');
            }
        };
        
        // 測試用戶手勢
        window.testUserGesture = function() {
            log('=== 測試用戶手勢 ===', 'info');
            
            const isTrustedEvent = event && event.isTrusted;
            const hasUserActivation = navigator.userActivation ? navigator.userActivation.hasBeenActive : 'unknown';
            
            log(`事件可信度: ${isTrustedEvent ? '✅ 可信' : '❌ 不可信'}`);
            log(`用戶激活: ${hasUserActivation}`);
            
            if (isTrustedEvent) {
                showStatus('用戶手勢測試通過', 'success');
            } else {
                showStatus('用戶手勢測試失敗 - 可能影響重定向', 'warning');
            }
        };
        
        // 測試彈出視窗支援
        window.testPopupSupport = function() {
            log('=== 測試彈出視窗支援 ===', 'info');
            
            try {
                const popup = window.open('', 'test', 'width=1,height=1');
                if (popup) {
                    popup.close();
                    log('✅ 瀏覽器支援彈出視窗', 'success');
                    showStatus('彈出視窗支援正常', 'success');
                } else {
                    log('❌ 彈出視窗被阻擋', 'error');
                    showStatus('彈出視窗被阻擋 - 建議使用重定向', 'warning');
                }
            } catch (error) {
                log(`❌ 彈出視窗測試失敗: ${error.message}`, 'error');
                showStatus('彈出視窗不支援', 'error');
            }
        };
        
        // 檢查 Safari 限制
        window.checkSafariRestrictions = function() {
            log('=== 檢查 Safari 限制 ===', 'info');
            
            const isSafari = /Safari/.test(navigator.userAgent) && !/Chrome/.test(navigator.userAgent);
            const isIOS = /iPad|iPhone|iPod/.test(navigator.userAgent);
            const isStandalone = window.navigator.standalone;
            
            log(`Safari 瀏覽器: ${isSafari ? '是' : '否'}`);
            log(`iOS 設備: ${isIOS ? '是' : '否'}`);
            log(`PWA 模式: ${isStandalone ? '是' : '否'}`);
            
            if (isSafari || isIOS) {
                log('⚠️ 檢測到 Safari/iOS，可能有重定向限制', 'warning');
                showStatus('Safari/iOS 有重定向限制 - 建議使用用戶手勢觸發', 'warning');
            } else {
                showStatus('瀏覽器應該支援正常重定向', 'success');
            }
            
            // 檢查第三方 Cookie
            try {
                document.cookie = "test=1; SameSite=None; Secure";
                const thirdPartyCookies = document.cookie.includes("test=1");
                document.cookie = "test=; expires=Thu, 01 Jan 1970 00:00:00 GMT";
                
                log(`第三方 Cookie: ${thirdPartyCookies ? '啟用' : '禁用'}`);
                if (!thirdPartyCookies && (isSafari || isIOS)) {
                    log('⚠️ Safari 禁用第三方 Cookie 可能影響 OAuth', 'warning');
                }
            } catch (e) {
                log('無法測試第三方 Cookie', 'warning');
            }
        };
        
        // 清除資料重試
        window.clearAllAndRetry = function() {
            log('=== 清除所有資料 ===', 'info');
            
            // 清除所有相關儲存
            sessionStorage.clear();
            localStorage.clear();
            
            // 清除 Service Worker 緩存
            if ('serviceWorker' in navigator) {
                navigator.serviceWorker.getRegistrations().then(registrations => {
                    registrations.forEach(registration => {
                        registration.unregister();
                    });
                });
            }
            
            log('✅ 已清除所有資料', 'success');
            showStatus('資料已清除，3秒後重新載入...', 'info');
            
            setTimeout(() => {
                window.location.reload();
            }, 3000);
        };
        
        // 檢查重定向結果
        async function checkRedirectResult() {
            try {
                const result = await getRedirectResult(auth);
                if (result && result.user) {
                    log(`✅ 重定向登入成功: ${result.user.email}`, 'success');
                    showStatus(`登入成功: ${result.user.email}`, 'success');
                } else {
                    log('沒有重定向結果', 'info');
                }
            } catch (error) {
                log(`檢查重定向結果失敗: ${error.message}`, 'error');
            }
        }
        
        // 監聽認證狀態
        onAuthStateChanged(auth, (user) => {
            if (user) {
                log(`🎉 用戶已登入: ${user.email}`, 'success');
                showStatus(`已登入: ${user.displayName || user.email}`, 'success');
            }
        });
        
        // 頁面載入時檢查
        window.addEventListener('load', () => {
            log('頁面載入完成');
            checkRedirectResult();
        });
    </script>
</body>
</html>

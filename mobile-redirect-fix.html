<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ‰‹æ©Ÿé‡å®šå‘ä¿®å¾©æ–¹æ¡ˆ</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            min-height: 100vh;
            padding: 15px;
        }
        .container {
            max-width: 500px;
            margin: 0 auto;
            background: rgba(255,255,255,0.1);
            padding: 20px;
            border-radius: 15px;
            backdrop-filter: blur(10px);
        }
        h1 { text-align: center; margin-bottom: 20px; font-size: 18px; }
        .solution {
            background: rgba(255,255,255,0.15);
            padding: 15px;
            margin: 15px 0;
            border-radius: 10px;
            border-left: 4px solid #ffd700;
        }
        .solution h3 {
            color: #ffd700;
            font-size: 14px;
            margin-bottom: 8px;
        }
        button {
            width: 100%;
            padding: 12px;
            margin: 8px 0;
            border: none;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
        }
        .primary { background: #4CAF50; color: white; }
        .secondary { background: #2196F3; color: white; }
        .warning { background: #FF9800; color: white; }
        .danger { background: #f44336; color: white; }
        button:hover { transform: translateY(-1px); }
        .log {
            background: rgba(0,0,0,0.4);
            padding: 12px;
            margin: 10px 0;
            border-radius: 8px;
            font-family: monospace;
            font-size: 11px;
            max-height: 150px;
            overflow-y: auto;
            white-space: pre-wrap;
        }
        .status {
            padding: 10px;
            margin: 8px 0;
            border-radius: 6px;
            font-weight: bold;
            font-size: 13px;
        }
        .success { background: rgba(76,175,80,0.9); }
        .error { background: rgba(244,67,54,0.9); }
        .info { background: rgba(33,150,243,0.9); }
        .warning-status { background: rgba(255,152,0,0.9); }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ”§ æ‰‹æ©Ÿé‡å®šå‘ç™»å…¥ä¿®å¾©</h1>
        
        <div class="solution">
            <h3>ğŸ¯ å•é¡Œç¢ºèª</h3>
            <p>æ‚¨çš„é‡å®šå‘ç™»å…¥è¢«é˜»æ“‹ï¼Œé€™åœ¨ iOS Safari å¾ˆå¸¸è¦‹ã€‚ä»¥ä¸‹æ˜¯å¹¾å€‹è§£æ±ºæ–¹æ¡ˆï¼š</p>
        </div>
        
        <div class="solution">
            <h3>ğŸš€ è§£æ±ºæ–¹æ¡ˆ 1ï¼šç”¨æˆ¶æ‰‹å‹¢è§¸ç™¼</h3>
            <p>é‡å®šå‘å¿…é ˆç”±çœŸå¯¦çš„ç”¨æˆ¶é»æ“Šè§¸ç™¼ï¼Œä¸èƒ½æ˜¯ç¨‹å¼è‡ªå‹•åŸ·è¡Œ</p>
            <button class="primary" onclick="userTriggeredRedirect()">ğŸ‘† ç”¨æˆ¶é»æ“Šè§¸ç™¼é‡å®šå‘</button>
        </div>
        
        <div class="solution">
            <h3>ğŸªŸ è§£æ±ºæ–¹æ¡ˆ 2ï¼šæ–°è¦–çª—é‡å®šå‘</h3>
            <p>åœ¨æ–°è¦–çª—ä¸­é–‹å•Ÿç™»å…¥ï¼Œé¿å…ä¸»é é¢è¢«é˜»æ“‹</p>
            <button class="secondary" onclick="newWindowRedirect()">ğŸ†• æ–°è¦–çª—é‡å®šå‘ç™»å…¥</button>
        </div>
        
        <div class="solution">
            <h3>ğŸ”„ è§£æ±ºæ–¹æ¡ˆ 3ï¼šå½ˆå‡ºè¦–çª—é™ç´š</h3>
            <p>å˜—è©¦å½ˆå‡ºè¦–çª—ï¼Œå¦‚æœå¤±æ•—å‰‡é™ç´šç‚ºé‡å®šå‘</p>
            <button class="warning" onclick="popupFallbackRedirect()">ğŸ”„ æ™ºèƒ½ç™»å…¥æ¨¡å¼</button>
        </div>
        
        <div class="solution">
            <h3>ğŸŒ è§£æ±ºæ–¹æ¡ˆ 4ï¼šç›´æ¥ OAuth URL</h3>
            <p>ç¹é Firebaseï¼Œç›´æ¥ä½¿ç”¨ Google OAuth URL</p>
            <button class="danger" onclick="directOAuthRedirect()">ğŸŒ ç›´æ¥ OAuth ç™»å…¥</button>
        </div>
        
        <div class="solution">
            <h3>ğŸ” è¨ºæ–·å·¥å…·</h3>
            <button onclick="testUserGesture()">æ¸¬è©¦ç”¨æˆ¶æ‰‹å‹¢</button>
            <button onclick="testPopupSupport()">æ¸¬è©¦å½ˆå‡ºè¦–çª—æ”¯æ´</button>
            <button onclick="checkSafariRestrictions()">æª¢æŸ¥ Safari é™åˆ¶</button>
            <button onclick="clearAllAndRetry()">æ¸…é™¤è³‡æ–™é‡è©¦</button>
        </div>
        
        <div id="status"></div>
        <div class="log" id="log"></div>
    </div>

    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
        import { 
            getAuth, 
            GoogleAuthProvider, 
            signInWithPopup, 
            signInWithRedirect, 
            getRedirectResult,
            onAuthStateChanged
        } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js';
        
        const firebaseConfig = {
            apiKey: "AIzaSyB1DXR1TC11ZDhIXAeyWyn0gXnxaYW6Cjs",
            authDomain: "my-wallet-app-815ce.firebaseapp.com",
            projectId: "my-wallet-app-815ce",
            storageBucket: "my-wallet-app-815ce.firebasestorage.app",
            messagingSenderId: "656225813708",
            appId: "1:656225813708:web:2acd800eedd53408b4ae69"
        };
        
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        
        function log(message, type = 'info') {
            const logDiv = document.getElementById('log');
            const timestamp = new Date().toLocaleTimeString();
            const color = type === 'error' ? '#ff6b6b' : 
                         type === 'success' ? '#51cf66' : 
                         type === 'warning' ? '#ffd43b' : '#74c0fc';
            logDiv.innerHTML += `<div style="color: ${color}">[${timestamp}] ${message}</div>`;
            logDiv.scrollTop = logDiv.scrollHeight;
            console.log(message);
        }
        
        function showStatus(message, type = 'info') {
            const statusDiv = document.getElementById('status');
            const className = type === 'warning' ? 'warning-status' : type;
            statusDiv.innerHTML = `<div class="status ${className}">${message}</div>`;
        }
        
        // è§£æ±ºæ–¹æ¡ˆ 1ï¼šç”¨æˆ¶æ‰‹å‹¢è§¸ç™¼é‡å®šå‘
        window.userTriggeredRedirect = async function() {
            try {
                log('=== ç”¨æˆ¶æ‰‹å‹¢è§¸ç™¼é‡å®šå‘ ===', 'info');
                showStatus('æ­£åœ¨ä½¿ç”¨ç”¨æˆ¶æ‰‹å‹¢è§¸ç™¼é‡å®šå‘...', 'info');
                
                // ç¢ºä¿é€™æ˜¯çœŸå¯¦çš„ç”¨æˆ¶æ‰‹å‹¢è§¸ç™¼
                if (!event || !event.isTrusted) {
                    throw new Error('éçœŸå¯¦ç”¨æˆ¶æ‰‹å‹¢');
                }
                
                const provider = new GoogleAuthProvider();
                provider.addScope('email');
                provider.addScope('profile');
                provider.setCustomParameters({
                    'prompt': 'select_account'
                });
                
                // è¨˜éŒ„å˜—è©¦
                sessionStorage.setItem('userGestureRedirect', JSON.stringify({
                    timestamp: Date.now(),
                    userAgent: navigator.userAgent
                }));
                
                log('åŸ·è¡Œç”¨æˆ¶æ‰‹å‹¢é‡å®šå‘...');
                await signInWithRedirect(auth, provider);
                log('âœ… é‡å®šå‘å·²è§¸ç™¼', 'success');
                
            } catch (error) {
                log(`âŒ ç”¨æˆ¶æ‰‹å‹¢é‡å®šå‘å¤±æ•—: ${error.message}`, 'error');
                showStatus(`é‡å®šå‘å¤±æ•—: ${error.message}`, 'error');
            }
        };
        
        // è§£æ±ºæ–¹æ¡ˆ 2ï¼šæ–°è¦–çª—é‡å®šå‘
        window.newWindowRedirect = function() {
            try {
                log('=== æ–°è¦–çª—é‡å®šå‘ ===', 'info');
                showStatus('æ­£åœ¨é–‹å•Ÿæ–°è¦–çª—é€²è¡Œç™»å…¥...', 'info');
                
                // å»ºæ§‹ OAuth URL
                const baseUrl = 'https://accounts.google.com/o/oauth2/v2/auth';
                const clientId = '656225813708-your-full-client-id.apps.googleusercontent.com'; // éœ€è¦å®Œæ•´çš„ client ID
                const redirectUri = encodeURIComponent(window.location.origin + '/accounting/');
                const scope = encodeURIComponent('email profile');
                const state = encodeURIComponent(JSON.stringify({
                    method: 'newWindow',
                    timestamp: Date.now()
                }));
                
                const oauthUrl = `${baseUrl}?` +
                    `client_id=${clientId}&` +
                    `redirect_uri=${redirectUri}&` +
                    `response_type=code&` +
                    `scope=${scope}&` +
                    `state=${state}&` +
                    `prompt=select_account`;
                
                log(`OAuth URL: ${oauthUrl}`);
                
                // åœ¨æ–°è¦–çª—é–‹å•Ÿ
                const newWindow = window.open(oauthUrl, 'googleLogin', 'width=500,height=600,scrollbars=yes,resizable=yes');
                
                if (!newWindow) {
                    throw new Error('ç„¡æ³•é–‹å•Ÿæ–°è¦–çª—ï¼Œå¯èƒ½è¢«å½ˆå‡ºè¦–çª—é˜»æ“‹å™¨é˜»æ“‹');
                }
                
                log('âœ… æ–°è¦–çª—å·²é–‹å•Ÿ', 'success');
                showStatus('è«‹åœ¨æ–°è¦–çª—ä¸­å®Œæˆç™»å…¥', 'info');
                
                // ç›£è½æ–°è¦–çª—é—œé–‰
                const checkClosed = setInterval(() => {
                    if (newWindow.closed) {
                        clearInterval(checkClosed);
                        log('æ–°è¦–çª—å·²é—œé–‰ï¼Œæª¢æŸ¥ç™»å…¥ç‹€æ…‹...', 'info');
                        setTimeout(() => {
                            checkRedirectResult();
                        }, 1000);
                    }
                }, 1000);
                
            } catch (error) {
                log(`âŒ æ–°è¦–çª—é‡å®šå‘å¤±æ•—: ${error.message}`, 'error');
                showStatus(`æ–°è¦–çª—å¤±æ•—: ${error.message}`, 'error');
            }
        };
        
        // è§£æ±ºæ–¹æ¡ˆ 3ï¼šå½ˆå‡ºè¦–çª—é™ç´š
        window.popupFallbackRedirect = async function() {
            try {
                log('=== æ™ºèƒ½ç™»å…¥æ¨¡å¼ ===', 'info');
                showStatus('æ­£åœ¨å˜—è©¦æœ€ä½³ç™»å…¥æ–¹å¼...', 'info');
                
                const provider = new GoogleAuthProvider();
                provider.addScope('email');
                provider.addScope('profile');
                
                try {
                    // å…ˆå˜—è©¦å½ˆå‡ºè¦–çª—
                    log('å˜—è©¦å½ˆå‡ºè¦–çª—ç™»å…¥...');
                    const result = await signInWithPopup(auth, provider);
                    
                    if (result && result.user) {
                        log(`âœ… å½ˆå‡ºè¦–çª—ç™»å…¥æˆåŠŸ: ${result.user.email}`, 'success');
                        showStatus(`ç™»å…¥æˆåŠŸ: ${result.user.email}`, 'success');
                        return;
                    }
                    
                } catch (popupError) {
                    log(`å½ˆå‡ºè¦–çª—å¤±æ•—: ${popupError.code} - é™ç´šç‚ºé‡å®šå‘`, 'warning');
                    
                    // å½ˆå‡ºè¦–çª—å¤±æ•—ï¼Œé™ç´šç‚ºé‡å®šå‘
                    if (popupError.code === 'auth/popup-blocked' || 
                        popupError.code === 'auth/cancelled-popup-request') {
                        
                        log('åŸ·è¡Œé™ç´šé‡å®šå‘...', 'info');
                        showStatus('å½ˆå‡ºè¦–çª—è¢«é˜»æ“‹ï¼Œè½‰ç‚ºé‡å®šå‘æ¨¡å¼...', 'warning');
                        
                        provider.setCustomParameters({
                            'prompt': 'select_account'
                        });
                        
                        await signInWithRedirect(auth, provider);
                        log('âœ… é™ç´šé‡å®šå‘å·²è§¸ç™¼', 'success');
                        
                    } else {
                        throw popupError;
                    }
                }
                
            } catch (error) {
                log(`âŒ æ™ºèƒ½ç™»å…¥å¤±æ•—: ${error.code} - ${error.message}`, 'error');
                showStatus(`æ™ºèƒ½ç™»å…¥å¤±æ•—: ${error.message}`, 'error');
            }
        };
        
        // è§£æ±ºæ–¹æ¡ˆ 4ï¼šç›´æ¥ OAuth URL
        window.directOAuthRedirect = function() {
            try {
                log('=== ç›´æ¥ OAuth é‡å®šå‘ ===', 'info');
                showStatus('ä½¿ç”¨ç›´æ¥ OAuth æ–¹å¼...', 'info');
                
                // é€™éœ€è¦å®Œæ•´çš„ Google OAuth è¨­å®š
                // æ³¨æ„ï¼šé€™æœƒç¹é Firebaseï¼Œéœ€è¦æ‰‹å‹•è™•ç†å›å‚³çš„æˆæ¬Šç¢¼
                
                const baseUrl = 'https://accounts.google.com/o/oauth2/v2/auth';
                const params = new URLSearchParams({
                    client_id: '656225813708-your-complete-client-id.apps.googleusercontent.com',
                    redirect_uri: window.location.href,
                    response_type: 'code',
                    scope: 'email profile',
                    state: 'direct_oauth',
                    prompt: 'select_account'
                });
                
                const directUrl = `${baseUrl}?${params.toString()}`;
                
                log(`ç›´æ¥è·³è½‰åˆ°: ${directUrl}`);
                sessionStorage.setItem('directOAuth', Date.now().toString());
                
                // ç›´æ¥è·³è½‰
                window.location.href = directUrl;
                
            } catch (error) {
                log(`âŒ ç›´æ¥ OAuth å¤±æ•—: ${error.message}`, 'error');
                showStatus(`ç›´æ¥ OAuth å¤±æ•—: ${error.message}`, 'error');
            }
        };
        
        // æ¸¬è©¦ç”¨æˆ¶æ‰‹å‹¢
        window.testUserGesture = function() {
            log('=== æ¸¬è©¦ç”¨æˆ¶æ‰‹å‹¢ ===', 'info');
            
            const isTrustedEvent = event && event.isTrusted;
            const hasUserActivation = navigator.userActivation ? navigator.userActivation.hasBeenActive : 'unknown';
            
            log(`äº‹ä»¶å¯ä¿¡åº¦: ${isTrustedEvent ? 'âœ… å¯ä¿¡' : 'âŒ ä¸å¯ä¿¡'}`);
            log(`ç”¨æˆ¶æ¿€æ´»: ${hasUserActivation}`);
            
            if (isTrustedEvent) {
                showStatus('ç”¨æˆ¶æ‰‹å‹¢æ¸¬è©¦é€šé', 'success');
            } else {
                showStatus('ç”¨æˆ¶æ‰‹å‹¢æ¸¬è©¦å¤±æ•— - å¯èƒ½å½±éŸ¿é‡å®šå‘', 'warning');
            }
        };
        
        // æ¸¬è©¦å½ˆå‡ºè¦–çª—æ”¯æ´
        window.testPopupSupport = function() {
            log('=== æ¸¬è©¦å½ˆå‡ºè¦–çª—æ”¯æ´ ===', 'info');
            
            try {
                const popup = window.open('', 'test', 'width=1,height=1');
                if (popup) {
                    popup.close();
                    log('âœ… ç€è¦½å™¨æ”¯æ´å½ˆå‡ºè¦–çª—', 'success');
                    showStatus('å½ˆå‡ºè¦–çª—æ”¯æ´æ­£å¸¸', 'success');
                } else {
                    log('âŒ å½ˆå‡ºè¦–çª—è¢«é˜»æ“‹', 'error');
                    showStatus('å½ˆå‡ºè¦–çª—è¢«é˜»æ“‹ - å»ºè­°ä½¿ç”¨é‡å®šå‘', 'warning');
                }
            } catch (error) {
                log(`âŒ å½ˆå‡ºè¦–çª—æ¸¬è©¦å¤±æ•—: ${error.message}`, 'error');
                showStatus('å½ˆå‡ºè¦–çª—ä¸æ”¯æ´', 'error');
            }
        };
        
        // æª¢æŸ¥ Safari é™åˆ¶
        window.checkSafariRestrictions = function() {
            log('=== æª¢æŸ¥ Safari é™åˆ¶ ===', 'info');
            
            const isSafari = /Safari/.test(navigator.userAgent) && !/Chrome/.test(navigator.userAgent);
            const isIOS = /iPad|iPhone|iPod/.test(navigator.userAgent);
            const isStandalone = window.navigator.standalone;
            
            log(`Safari ç€è¦½å™¨: ${isSafari ? 'æ˜¯' : 'å¦'}`);
            log(`iOS è¨­å‚™: ${isIOS ? 'æ˜¯' : 'å¦'}`);
            log(`PWA æ¨¡å¼: ${isStandalone ? 'æ˜¯' : 'å¦'}`);
            
            if (isSafari || isIOS) {
                log('âš ï¸ æª¢æ¸¬åˆ° Safari/iOSï¼Œå¯èƒ½æœ‰é‡å®šå‘é™åˆ¶', 'warning');
                showStatus('Safari/iOS æœ‰é‡å®šå‘é™åˆ¶ - å»ºè­°ä½¿ç”¨ç”¨æˆ¶æ‰‹å‹¢è§¸ç™¼', 'warning');
            } else {
                showStatus('ç€è¦½å™¨æ‡‰è©²æ”¯æ´æ­£å¸¸é‡å®šå‘', 'success');
            }
            
            // æª¢æŸ¥ç¬¬ä¸‰æ–¹ Cookie
            try {
                document.cookie = "test=1; SameSite=None; Secure";
                const thirdPartyCookies = document.cookie.includes("test=1");
                document.cookie = "test=; expires=Thu, 01 Jan 1970 00:00:00 GMT";
                
                log(`ç¬¬ä¸‰æ–¹ Cookie: ${thirdPartyCookies ? 'å•Ÿç”¨' : 'ç¦ç”¨'}`);
                if (!thirdPartyCookies && (isSafari || isIOS)) {
                    log('âš ï¸ Safari ç¦ç”¨ç¬¬ä¸‰æ–¹ Cookie å¯èƒ½å½±éŸ¿ OAuth', 'warning');
                }
            } catch (e) {
                log('ç„¡æ³•æ¸¬è©¦ç¬¬ä¸‰æ–¹ Cookie', 'warning');
            }
        };
        
        // æ¸…é™¤è³‡æ–™é‡è©¦
        window.clearAllAndRetry = function() {
            log('=== æ¸…é™¤æ‰€æœ‰è³‡æ–™ ===', 'info');
            
            // æ¸…é™¤æ‰€æœ‰ç›¸é—œå„²å­˜
            sessionStorage.clear();
            localStorage.clear();
            
            // æ¸…é™¤ Service Worker ç·©å­˜
            if ('serviceWorker' in navigator) {
                navigator.serviceWorker.getRegistrations().then(registrations => {
                    registrations.forEach(registration => {
                        registration.unregister();
                    });
                });
            }
            
            log('âœ… å·²æ¸…é™¤æ‰€æœ‰è³‡æ–™', 'success');
            showStatus('è³‡æ–™å·²æ¸…é™¤ï¼Œ3ç§’å¾Œé‡æ–°è¼‰å…¥...', 'info');
            
            setTimeout(() => {
                window.location.reload();
            }, 3000);
        };
        
        // æª¢æŸ¥é‡å®šå‘çµæœ
        async function checkRedirectResult() {
            try {
                const result = await getRedirectResult(auth);
                if (result && result.user) {
                    log(`âœ… é‡å®šå‘ç™»å…¥æˆåŠŸ: ${result.user.email}`, 'success');
                    showStatus(`ç™»å…¥æˆåŠŸ: ${result.user.email}`, 'success');
                } else {
                    log('æ²’æœ‰é‡å®šå‘çµæœ', 'info');
                }
            } catch (error) {
                log(`æª¢æŸ¥é‡å®šå‘çµæœå¤±æ•—: ${error.message}`, 'error');
            }
        }
        
        // ç›£è½èªè­‰ç‹€æ…‹
        onAuthStateChanged(auth, (user) => {
            if (user) {
                log(`ğŸ‰ ç”¨æˆ¶å·²ç™»å…¥: ${user.email}`, 'success');
                showStatus(`å·²ç™»å…¥: ${user.displayName || user.email}`, 'success');
            }
        });
        
        // é é¢è¼‰å…¥æ™‚æª¢æŸ¥
        window.addEventListener('load', () => {
            log('é é¢è¼‰å…¥å®Œæˆ');
            checkRedirectResult();
        });
    </script>
</body>
</html>
